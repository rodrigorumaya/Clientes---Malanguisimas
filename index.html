<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Estratégico de Clientes - Malanguísimas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #FDF8F0 0%, #F9E4D4 100%);
            color: #4E443A;
            min-height: 100vh;
        }
        
        /* Animaciones globales */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Sistema de tabs */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-btn {
            position: relative;
            overflow: hidden;
        }
        
        .tab-btn.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .tab-btn:hover::before {
            left: 100%;
        }
        
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 50;
            animation: slideInRight 0.5s ease-out;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
        }
        
        /* Tarjetas mejoradas */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        /* Botones mejorados */
        .btn-primary {
            background: linear-gradient(135deg, #8D6E63 0%, #A1887F 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
        }
        
        /* Indicador de sincronización */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .sync-status.synced {
            background-color: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }
        
        .sync-status.syncing {
            background-color: rgba(251, 191, 36, 0.1);
            color: #d97706;
        }
        
        .sync-status.offline {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .sync-status .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .sync-status.synced .sync-dot {
            background-color: #22c55e;
        }
        
        .sync-status.syncing .sync-dot {
            background-color: #fbbf24;
            animation: pulse 0.8s infinite;
        }
        
        .sync-status.offline .sync-dot {
            background-color: #ef4444;
            animation: none;
        }
        
        /* Usuarios activos */
        .active-users {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar.editing {
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
        }
        
        /* Indicador de edición */
        .editing-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background-color: #fbbf24;
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse 1s infinite;
        }
        
        /* Gráficas */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
                max-height: 450px;
            }
        }
        
        .bubble-chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 500px;
        }
        
        @media (min-width: 768px) {
            .bubble-chart-container {
                height: 500px;
            }
        }
        
        /* Filtros y toggles */
        .active-filter {
            background: linear-gradient(135deg, #8D6E63 0%, #A1887F 100%);
            color: #FFFFFF;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(141, 110, 99, 0.3);
        }
        
        .inactive-filter {
            background-color: #EFEBE9;
            color: #795548;
            transition: all 0.3s ease;
        }
        
        .inactive-filter:hover {
            background-color: #E0D6CF;
            transform: scale(1.02);
        }
        
        /* Modales mejorados */
        .modal {
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Toggle buttons */
        .view-toggle-btn.active {
            background: linear-gradient(135deg, #8D6E63 0%, #A1887F 100%);
            color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(141, 110, 99, 0.3);
        }
        
        .view-toggle-btn.inactive {
            background-color: #EFEBE9;
            color: #795548;
        }
        
        /* Lista de clientes individual */
        .individual-client-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(141, 110, 99, 0.1);
            cursor: pointer;
            position: relative;
        }
        
        .individual-client-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
            border-color: rgba(141, 110, 99, 0.3);
        }
        
        .client-list-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        /* Scrollbar personalizado */
        .client-list-container::-webkit-scrollbar,
        .tab-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .client-list-container::-webkit-scrollbar-track,
        .tab-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .client-list-container::-webkit-scrollbar-thumb,
        .tab-content::-webkit-scrollbar-thumb {
            background: #A1887F;
            border-radius: 10px;
        }
        
        .client-list-container::-webkit-scrollbar-thumb:hover,
        .tab-content::-webkit-scrollbar-thumb:hover {
            background: #8D6E63;
        }
        
        /* Accordion mejorado */
        .accordion-item {
            transition: all 0.3s ease;
        }
        
        .accordion-item:hover {
            transform: translateY(-2px);
        }
        
        /* Header mejorado */
        .header-gradient {
            background: linear-gradient(135deg, #8D6E63 0%, #A1887F 100%);
        }
        
        /* Iconos de eliminar */
        .delete-btn {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .individual-client-item:hover .delete-btn,
        .delivery-item:hover .delete-btn,
        .reminder-item:hover .delete-btn,
        .sale-item:hover .delete-btn,
        .interaction-item:hover .delete-btn {
            opacity: 1;
        }
        
        /* Animación de entrada para elementos nuevos */
        .new-item {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Efectos de hover para las tarjetas de segmento */
        .segment-card {
            position: relative;
            overflow: hidden;
        }
        
        .segment-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.5s ease;
        }
        
        .segment-card:hover::before {
            transform: scale(1);
        }
        
        /* Métricas animadas */
        .metric-value {
            animation: pulse 2s infinite;
        }
        
        /* Dashboard grid */
        .dashboard-grid {
            display: grid;
            gap: 2rem;
        }
        
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Map container */
        #clients-map, #location-selector-map {
            height: 500px;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        /* Progress bars */
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            transition: width 0.5s ease;
        }
        
        /* Timeline */
        .timeline-item {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 1.5rem;
            border-left: 2px solid #e5e7eb;
        }
        
        .timeline-item:last-child {
            border-left: none;
        }
        
        .timeline-dot {
            position: absolute;
            left: -5px;
            top: 0;
            width: 10px;
            height: 10px;
            background-color: #8D6E63;
            border-radius: 50%;
        }
        
        /* Metric cards with trend */
        .metric-card {
            position: relative;
            overflow: hidden;
        }
        
        .metric-trend {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .trend-up {
            color: #22c55e;
        }
        
        .trend-down {
            color: #ef4444;
        }
        
        /* KPI cards */
        .kpi-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 1.5rem;
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(141, 110, 99, 0.1) 0%, transparent 70%);
            animation: pulse 3s infinite;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #8D6E63;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Botón de confirmar ubicación cuando hay cambios */
        #confirm-map-selection.animate-pulse {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            transform: scale(1.05);
        }
        
        /* Estilo del botón cuando no hay cambios (mantener ubicación actual) */
        #confirm-map-selection:not(.animate-pulse):not(:disabled) {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        #confirm-map-selection:not(.animate-pulse):not(:disabled):hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: scale(1.02);
        }
        
        /* Animación de sincronización */
        @keyframes sync-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .syncing-icon {
            animation: sync-spin 1s linear infinite;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600">Cargando...</p>
    </div>
    
    <!-- Sistema de notificaciones -->
    <div id="notification-container"></div>

    <!-- Header mejorado con menú de tabs -->
    <header class="header-gradient text-white shadow-lg sticky top-0 z-20">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <span class="text-3xl animate-pulse">🌶️</span>
                    Malanguísimas
                </h1>
                <div class="flex items-center gap-4">
                    <!-- Indicador de sincronización -->
                    <div id="sync-status" class="sync-status synced">
                        <div class="sync-dot"></div>
                        <span id="sync-text">Sincronizado</span>
                    </div>
                    
                    <!-- Usuarios activos -->
                    <div id="active-users" class="active-users hidden">
                        <!-- Se llena dinámicamente -->
                    </div>
                    
                    <span class="text-sm">Última actualización: <span id="last-update">Hoy</span></span>
                    <button id="mobile-menu-btn" class="md:hidden text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Sistema de tabs para navegación más concisa -->
            <div class="flex flex-wrap gap-2 justify-center">
                <button class="tab-btn active bg-white/20 px-4 py-2 rounded-full font-medium transition-all hover:bg-white/30" data-tab="dashboard">
                    <span class="flex items-center gap-2">
                        <span>📊</span>
                        Dashboard
                    </span>
                </button>
                <button class="tab-btn bg-white/10 px-4 py-2 rounded-full font-medium transition-all hover:bg-white/30" data-tab="sales">
                    <span class="flex items-center gap-2">
                        <span>💰</span>
                        Ventas
                    </span>
                </button>
                <button class="tab-btn bg-white/10 px-4 py-2 rounded-full font-medium transition-all hover:bg-white/30" data-tab="clients">
                    <span class="flex items-center gap-2">
                        <span>👥</span>
                        Clientes
                    </span>
                </button>
                <button class="tab-btn bg-white/10 px-4 py-2 rounded-full font-medium transition-all hover:bg-white/30" data-tab="crm">
                    <span class="flex items-center gap-2">
                        <span>💬</span>
                        CRM
                    </span>
                </button>
                <button class="tab-btn bg-white/10 px-4 py-2 rounded-full font-medium transition-all hover:bg-white/30" data-tab="map">
                    <span class="flex items-center gap-2">
                        <span>🗺️</span>
                        Mapa
                    </span>
                </button>
                <button class="tab-btn bg-white/10 px-4 py-2 rounded-full font-medium transition-all hover:bg-white/30" data-tab="operations">
                    <span class="flex items-center gap-2">
                        <span>📦</span>
                        Operaciones
                    </span>
                </button>
                <button class="tab-btn bg-white/10 px-4 py-2 rounded-full font-medium transition-all hover:bg-white/30" data-tab="insights">
                    <span class="flex items-center gap-2">
                        <span>💡</span>
                        Insights
                    </span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Tab: Dashboard -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-[#8D6E63] mb-2">Panel de Control</h2>
                <p class="text-lg max-w-3xl mx-auto text-gray-600">Vista general de tu negocio y métricas clave.</p>
            </div>
            
            <!-- KPIs principales -->
            <div class="grid md:grid-cols-4 gap-6 mb-12">
                <div class="kpi-card">
                    <span class="metric-trend trend-up">↑ 15%</span>
                    <div class="text-3xl mb-2">💰</div>
                    <h3 class="text-sm font-semibold text-gray-600 mb-1">Ventas del Mes</h3>
                    <p id="monthly-sales" class="text-2xl font-bold text-[#8D6E63]">$0</p>
                </div>
                <div class="kpi-card">
                    <span class="metric-trend trend-up">↑ 8%</span>
                    <div class="text-3xl mb-2">📈</div>
                    <h3 class="text-sm font-semibold text-gray-600 mb-1">Ticket Promedio</h3>
                    <p id="avg-ticket" class="text-2xl font-bold text-[#8D6E63]">$0</p>
                </div>
                <div class="kpi-card">
                    <span class="metric-trend trend-down">↓ 3%</span>
                    <div class="text-3xl mb-2">👥</div>
                    <h3 class="text-sm font-semibold text-gray-600 mb-1">Clientes Activos</h3>
                    <p id="active-clients" class="text-2xl font-bold text-[#8D6E63]">0</p>
                </div>
                <div class="kpi-card">
                    <span class="metric-trend trend-up">↑ 12%</span>
                    <div class="text-3xl mb-2">🎯</div>
                    <h3 class="text-sm font-semibold text-gray-600 mb-1">Meta Cumplida</h3>
                    <p id="goal-percentage" class="text-2xl font-bold text-[#FFAB91]">0%</p>
                </div>
            </div>

            <!-- Progreso de metas -->
            <div class="glass-card p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-bold mb-4">Progreso de Metas Mensuales</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Ventas</span>
                            <span class="text-sm font-medium" id="sales-progress">$0 / $50,000</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="sales-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Nuevos Clientes</span>
                            <span class="text-sm font-medium" id="clients-progress">0 / 10</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="clients-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium">Entregas</span>
                            <span class="text-sm font-medium" id="deliveries-progress">0 / 100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="deliveries-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficas en grid -->
            <div class="dashboard-grid">
                <div class="glass-card p-6 sm:p-8 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-center mb-6">Distribución del Portafolio</h3>
                    <div class="chart-container">
                        <canvas id="portfolioDistributionChart"></canvas>
                    </div>
                </div>

                <div class="glass-card p-6 sm:p-8 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-center mb-6">Ventas por Segmento</h3>
                    <div class="chart-container">
                        <canvas id="salesBySegmentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Ventas -->
        <div id="sales-tab" class="tab-content">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-[#8D6E63] mb-2">Gestión de Ventas</h2>
                <p class="text-lg max-w-3xl mx-auto text-gray-600">Registra y analiza tus ventas para tomar mejores decisiones.</p>
                <button id="add-sale-btn" class="mt-6 btn-success px-8 py-3 rounded-full font-semibold shadow-lg">
                    <span class="flex items-center gap-2">
                        <span>💵</span>
                        Registrar Venta
                    </span>
                </button>
            </div>

            <!-- Resumen de ventas -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="glass-card p-6 rounded-xl shadow-lg text-center">
                    <h3 class="text-lg font-semibold mb-2">Ventas Hoy</h3>
                    <p id="today-sales" class="text-3xl font-bold text-[#22c55e]">$0</p>
                </div>
                <div class="glass-card p-6 rounded-xl shadow-lg text-center">
                    <h3 class="text-lg font-semibold mb-2">Ventas Esta Semana</h3>
                    <p id="week-sales" class="text-3xl font-bold text-[#8D6E63]">$0</p>
                </div>
                <div class="glass-card p-6 rounded-xl shadow-lg text-center">
                    <h3 class="text-lg font-semibold mb-2">Ventas Este Mes</h3>
                    <p id="month-sales" class="text-3xl font-bold text-[#FFAB91]">$0</p>
                </div>
            </div>

            <!-- Gráfica de tendencias -->
            <div class="glass-card p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-2xl font-bold mb-6">Tendencia de Ventas (Últimos 30 días)</h3>
                <div style="height: 300px;">
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>

            <!-- Historial de ventas -->
            <div class="glass-card p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-bold mb-6">Historial de Ventas</h3>
                <div id="sales-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-600 text-center">No hay ventas registradas</p>
                </div>
            </div>
        </div>

        <!-- Tab: Clientes -->
        <div id="clients-tab" class="tab-content">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-[#8D6E63] mb-2">Gestión de Clientes</h2>
                <p class="text-lg max-w-3xl mx-auto text-gray-600">Explora tus clientes por segmentos estratégicos o administra tu lista completa.</p>
                <button id="add-client-btn" class="mt-6 btn-primary text-white px-8 py-3 rounded-full font-semibold shadow-lg">
                    <span class="flex items-center gap-2">
                        <span>➕</span>
                        Añadir Cliente
                    </span>
                </button>
            </div>
            
            <div class="flex justify-center space-x-2 sm:space-x-4 mb-8">
                <button id="view-segments-btn" class="view-toggle-btn active px-6 py-3 rounded-full font-semibold transition">Ver Segmentos</button>
                <button id="view-individual-clients-btn" class="view-toggle-btn inactive px-6 py-3 rounded-full font-semibold transition">Ver Lista Completa</button>
            </div>

            <!-- Filtros para vista de segmentos -->
            <div id="segment-filter-container" class="flex justify-center space-x-2 sm:space-x-4 mb-8 flex-wrap gap-2">
                <button class="filter-btn active-filter px-4 py-2 rounded-full font-semibold transition" data-filter="all">Todos</button>
                <button class="filter-btn inactive-filter px-4 py-2 rounded-full font-semibold transition" data-filter="Alta">Alta</button>
                <button class="filter-btn inactive-filter px-4 py-2 rounded-full font-semibold transition" data-filter="Media">Media</button>
                <button class="filter-btn inactive-filter px-4 py-2 rounded-full font-semibold transition" data-filter="Baja">Baja</button>
                <button class="filter-btn inactive-filter px-4 py-2 rounded-full font-semibold transition" data-filter="Requiere Clarificación">Sin Clasificar</button>
            </div>

            <!-- Opciones de ordenamiento para lista de clientes -->
            <div id="sort-options-container" class="hidden justify-center items-center space-x-4 mb-8">
                <label for="sort-by" class="text-gray-700 font-medium">Ordenar por:</label>
                <select id="sort-by" class="border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-[#FFAB91] focus:border-[#FFAB91]">
                    <option value="name">Cliente</option>
                    <option value="location">Ubicación</option>
                    <option value="category">Categoría</option>
                </select>
                <label for="sort-order" class="text-gray-700 font-medium">Orden:</label>
                <select id="sort-order" class="border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-[#FFAB91] focus:border-[#FFAB91]">
                    <option value="asc">A-Z</option>
                    <option value="desc">Z-A</option>
                </select>
            </div>

            <div id="client-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Las tarjetas de segmentos o lista de clientes se renderizan aquí -->
            </div>
        </div>

        <!-- Tab: CRM -->
        <div id="crm-tab" class="tab-content">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-[#8D6E63] mb-2">CRM - Gestión de Relaciones</h2>
                <p class="text-lg max-w-3xl mx-auto text-gray-600">Mantén un historial detallado de interacciones con tus clientes.</p>
            </div>

            <!-- Selector de cliente -->
            <div class="glass-card p-6 rounded-xl shadow-lg mb-8">
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-grow">
                        <label for="crm-client-select" class="block text-sm font-medium text-gray-700 mb-1">Selecciona un Cliente:</label>
                        <select id="crm-client-select" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]">
                            <option value="">Selecciona un cliente para ver su historial</option>
                        </select>
                    </div>
                    <button id="add-interaction-btn" class="btn-primary text-white px-6 py-3 rounded-full font-semibold" disabled>
                        <span class="flex items-center gap-2">
                            <span>💬</span>
                            Añadir Interacción
                        </span>
                    </button>
                </div>
            </div>

            <!-- Información del cliente -->
            <div id="client-info-section" class="hidden">
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Detalles del cliente -->
                    <div class="glass-card p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <span>📋</span>
                            Información del Cliente
                        </h3>
                        <div id="client-details" class="space-y-3">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>

                    <!-- Métricas del cliente -->
                    <div class="glass-card p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <span>📊</span>
                            Métricas
                        </h3>
                        <div id="client-metrics" class="space-y-3">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Timeline de interacciones -->
                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                        <span>⏱️</span>
                        Historial de Interacciones
                    </h3>
                    <div id="interactions-timeline" class="space-y-4">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Mapa -->
        <div id="map-tab" class="tab-content">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-[#8D6E63] mb-2">Mapa de Clientes</h2>
                <p class="text-lg max-w-3xl mx-auto text-gray-600">Visualiza la ubicación de tus clientes y optimiza tus rutas de entrega.</p>
            </div>

            <!-- Controles del mapa -->
            <div class="glass-card p-4 rounded-xl shadow-lg mb-6">
                <div class="flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex gap-2">
                        <button class="map-filter-btn active px-4 py-2 rounded-full text-sm font-medium bg-[#8D6E63] text-white" data-filter="all">
                            Todos
                        </button>
                        <button class="map-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700" data-filter="Alta">
                            Alta Prioridad
                        </button>
                        <button class="map-filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700" data-filter="pending">
                            Pendientes
                        </button>
                    </div>
                    <button id="optimize-route-btn" class="btn-success px-6 py-2 rounded-full font-semibold">
                        <span class="flex items-center gap-2">
                            <span>🚚</span>
                            Optimizar Ruta
                        </span>
                    </button>
                </div>
            </div>

            <!-- Mapa -->
            <div class="glass-card p-2 rounded-xl shadow-lg">
                <div id="clients-map"></div>
            </div>

            <!-- Estadísticas del mapa -->
            <div class="grid md:grid-cols-3 gap-6 mt-6">
                <div class="glass-card p-4 rounded-lg text-center">
                    <h4 class="text-sm font-medium text-gray-600">Clientes en el Mapa</h4>
                    <p id="map-clients-count" class="text-2xl font-bold text-[#8D6E63]">0</p>
                </div>
                <div class="glass-card p-4 rounded-lg text-center">
                    <h4 class="text-sm font-medium text-gray-600">Zonas Cubiertas</h4>
                    <p id="map-zones-count" class="text-2xl font-bold text-[#8D6E63]">0</p>
                </div>
                <div class="glass-card p-4 rounded-lg text-center">
                    <h4 class="text-sm font-medium text-gray-600">Distancia Total</h4>
                    <p id="map-distance" class="text-2xl font-bold text-[#8D6E63]">0 km</p>
                </div>
            </div>
        </div>

        <!-- Tab: Operaciones -->
        <div id="operations-tab" class="tab-content">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-[#8D6E63] mb-2">Gestión Operativa</h2>
                <p class="text-lg max-w-3xl mx-auto text-gray-600">Registra entregas y configura recordatorios para mantener una comunicación efectiva.</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Registro de Entregas -->
                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-center mb-6 text-[#A1887F] flex items-center justify-center gap-2">
                        <span>📦</span>
                        Registro de Entregas
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="delivery-client-select" class="block text-sm font-medium text-gray-700 mb-1">Cliente:</label>
                            <select id="delivery-client-select" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]">
                                <option value="">Selecciona un cliente</option>
                            </select>
                        </div>
                        <div>
                            <label for="delivery-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha:</label>
                            <input type="date" id="delivery-date" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]">
                        </div>
                        <button id="add-delivery-btn" class="w-full btn-primary text-white px-6 py-3 rounded-full font-semibold shadow-md">Registrar</button>
                    </div>

                    <div class="mt-8">
                        <h4 class="text-xl font-semibold mb-4 text-[#795548]">Historial</h4>
                        <div id="delivery-list" class="space-y-3 max-h-64 overflow-y-auto">
                            <p class="text-gray-600 text-center">No hay entregas registradas</p>
                        </div>
                    </div>
                </div>

                <!-- Recordatorios Semanales -->
                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-center mb-6 text-[#A1887F] flex items-center justify-center gap-2">
                        <span>🔔</span>
                        Recordatorios
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="reminder-segment-select" class="block text-sm font-medium text-gray-700 mb-1">Segmento:</label>
                            <select id="reminder-segment-select" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]">
                                <option value="">Selecciona un segmento</option>
                            </select>
                        </div>
                        <div>
                            <label for="reminder-day" class="block text-sm font-medium text-gray-700 mb-1">Día:</label>
                            <select id="reminder-day" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]">
                                <option value="">Selecciona un día</option>
                                <option value="Lunes">Lunes</option>
                                <option value="Martes">Martes</option>
                                <option value="Miércoles">Miércoles</option>
                                <option value="Jueves">Jueves</option>
                                <option value="Viernes">Viernes</option>
                                <option value="Sábado">Sábado</option>
                                <option value="Domingo">Domingo</option>
                            </select>
                        </div>
                        <div>
                            <label for="reminder-text" class="block text-sm font-medium text-gray-700 mb-1">Mensaje:</label>
                            <textarea id="reminder-text" rows="2" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" placeholder="Ej: Seguimiento semanal..."></textarea>
                        </div>
                        <button id="add-reminder-btn" class="w-full btn-primary text-white px-6 py-3 rounded-full font-semibold shadow-md">Configurar</button>
                    </div>

                    <div class="mt-8">
                        <h4 class="text-xl font-semibold mb-4 text-[#795548]">Activos</h4>
                        <div id="reminder-list" class="space-y-3 max-h-64 overflow-y-auto">
                            <p class="text-gray-600 text-center">No hay recordatorios</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Insights -->
        <div id="insights-tab" class="tab-content">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-[#8D6E63] mb-2">Insights y Estrategias</h2>
                <p class="text-lg max-w-3xl mx-auto text-gray-600">Recomendaciones clave para implementar tu estrategia y asegurar el crecimiento sostenible.</p>
            </div>
            <div id="recommendations-accordion" class="space-y-4 max-w-4xl mx-auto">
                <!-- El acordeón se genera dinámicamente -->
            </div>
        </div>
    </main>
    
    <!-- Modal para detalles del segmento -->
    <div id="segment-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto relative">
            <button id="close-segment-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl transition hover:rotate-90 transform">✕</button>
            <div id="modal-content" class="p-8">
                <!-- El contenido se inyecta dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para añadir cliente individual -->
    <div id="add-client-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative p-8">
            <button id="close-add-client-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl transition hover:rotate-90 transform">✕</button>
            <h2 class="text-3xl font-bold text-[#8D6E63] mb-6 text-center">Nuevo Cliente</h2>
            <form id="add-client-form" class="grid grid-cols-1 gap-6">
                <div>
                    <label for="new-client-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre <span class="text-red-500">*</span></label>
                    <input type="text" id="new-client-name" name="clientName" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                </div>
                <div>
                    <label for="new-client-location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación <span class="text-red-500">*</span></label>
                    <input type="text" id="new-client-location" name="clientLocation" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                </div>
                <div>
                    <label for="new-client-category" class="block text-sm font-medium text-gray-700 mb-1">Segmento <span class="text-red-500">*</span></label>
                    <select id="new-client-category" name="clientCategory" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                        <option value="">Selecciona un segmento</option>
                        <option value="new">➕ Crear nuevo segmento...</option>
                    </select>
                    <input type="text" id="new-category-input" name="newCategory" class="mt-2 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91] hidden" placeholder="Nombre del nuevo segmento">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación <span class="text-red-500">*</span></label>
                    <div class="space-y-2">
                        <button type="button" id="select-on-map-btn" class="w-full btn-primary text-white px-4 py-2 rounded-lg font-medium">
                            📍 Seleccionar en el Mapa
                        </button>
                        <div id="coordinates-display" class="text-sm text-gray-600 text-center hidden">
                            Lat: <span id="selected-lat">-</span>, Lng: <span id="selected-lng">-</span>
                        </div>
                        <input type="hidden" id="new-client-lat" name="clientLat">
                        <input type="hidden" id="new-client-lng" name="clientLng">
                    </div>
                </div>
                <div class="col-span-1 flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-add-client-btn" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-[#E0E0E0] transition">Cancelar</button>
                    <button type="submit" class="px-6 py-2 rounded-full font-semibold btn-primary text-white">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para añadir venta -->
    <div id="add-sale-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative p-8">
            <button id="close-add-sale-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl transition hover:rotate-90 transform">✕</button>
            <h2 class="text-3xl font-bold text-[#8D6E63] mb-6 text-center">Registrar Venta</h2>
            <form id="add-sale-form" class="grid grid-cols-1 gap-6">
                <div>
                    <label for="sale-client" class="block text-sm font-medium text-gray-700 mb-1">Cliente <span class="text-red-500">*</span></label>
                    <select id="sale-client" name="saleClient" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                        <option value="">Selecciona un cliente</option>
                    </select>
                </div>
                <div>
                    <label for="sale-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto <span class="text-red-500">*</span></label>
                    <input type="number" id="sale-amount" name="saleAmount" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                </div>
                <div>
                    <label for="sale-products" class="block text-sm font-medium text-gray-700 mb-1">Productos</label>
                    <textarea id="sale-products" name="saleProducts" rows="2" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" placeholder="Ej: 5 bolsas grandes, 3 bolsas pequeñas"></textarea>
                </div>
                <div>
                    <label for="sale-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha <span class="text-red-500">*</span></label>
                    <input type="datetime-local" id="sale-date" name="saleDate" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                </div>
                <div class="col-span-1 flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-add-sale-btn" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-[#E0E0E0] transition">Cancelar</button>
                    <button type="submit" class="px-6 py-2 rounded-full font-semibold btn-success">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para añadir interacción -->
    <div id="add-interaction-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative p-8">
            <button id="close-add-interaction-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl transition hover:rotate-90 transform">✕</button>
            <h2 class="text-3xl font-bold text-[#8D6E63] mb-6 text-center">Nueva Interacción</h2>
            <form id="add-interaction-form" class="grid grid-cols-1 gap-6">
                <div>
                    <label for="interaction-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo <span class="text-red-500">*</span></label>
                    <select id="interaction-type" name="interactionType" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                        <option value="">Selecciona el tipo</option>
                        <option value="call">📞 Llamada</option>
                        <option value="visit">🏪 Visita</option>
                        <option value="message">💬 Mensaje</option>
                        <option value="email">📧 Email</option>
                        <option value="complaint">😟 Queja</option>
                        <option value="compliment">😊 Felicitación</option>
                    </select>
                </div>
                <div>
                    <label for="interaction-notes" class="block text-sm font-medium text-gray-700 mb-1">Notas <span class="text-red-500">*</span></label>
                    <textarea id="interaction-notes" name="interactionNotes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required placeholder="Describe la interacción..."></textarea>
                </div>
                <div>
                    <label for="interaction-satisfaction" class="block text-sm font-medium text-gray-700 mb-1">Nivel de Satisfacción</label>
                    <select id="interaction-satisfaction" name="interactionSatisfaction" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]">
                        <option value="">No aplica</option>
                        <option value="5">⭐⭐⭐⭐⭐ Excelente</option>
                        <option value="4">⭐⭐⭐⭐ Bueno</option>
                        <option value="3">⭐⭐⭐ Regular</option>
                        <option value="2">⭐⭐ Malo</option>
                        <option value="1">⭐ Muy Malo</option>
                    </select>
                </div>
                <div>
                    <label for="interaction-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha <span class="text-red-500">*</span></label>
                    <input type="datetime-local" id="interaction-date" name="interactionDate" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                </div>
                <div class="col-span-1 flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-add-interaction-btn" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-[#E0E0E0] transition">Cancelar</button>
                    <button type="submit" class="px-6 py-2 rounded-full font-semibold btn-primary text-white">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para seleccionar ubicación en el mapa -->
    <div id="map-selector-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden relative">
            <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-[#8D6E63] to-[#A1887F]">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <span>📍</span>
                    Seleccionar Ubicación
                </h2>
                <p class="text-sm text-white/90 mt-1">Haz clic en cualquier punto del mapa para establecer o cambiar la ubicación</p>
            </div>
            <div id="location-selector-map" style="height: 500px;"></div>
            <div class="p-4 border-t border-gray-200 flex justify-between items-center bg-gray-50">
                <div class="text-sm text-gray-600 font-medium">
                    <span id="map-instructions">Haz clic en cualquier punto del mapa para seleccionar la ubicación</span>
                </div>
                <div class="flex gap-2">
                    <button type="button" id="cancel-map-selection" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                    <button type="button" id="confirm-map-selection" class="px-8 py-3 rounded-full font-semibold btn-success shadow-lg" disabled>
                        ✅ Confirmar Ubicación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar cliente -->
    <div id="edit-client-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative p-8">
            <button id="close-edit-client-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl transition hover:rotate-90 transform">✕</button>
            <h2 class="text-3xl font-bold text-[#8D6E63] mb-6 text-center">Editar Cliente</h2>
            <form id="edit-client-form" class="grid grid-cols-1 gap-6">
                <input type="hidden" id="edit-client-id">
                <div>
                    <label for="edit-client-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-client-name" name="clientName" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                </div>
                <div>
                    <label for="edit-client-location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-client-location" name="clientLocation" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                </div>
                <div>
                    <label for="edit-client-category" class="block text-sm font-medium text-gray-700 mb-1">Segmento <span class="text-red-500">*</span></label>
                    <select id="edit-client-category" name="clientCategory" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-[#FFAB91] focus:border-[#FFAB91]" required>
                        <option value="">Selecciona un segmento</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación en el Mapa</label>
                    <div class="space-y-2">
                        <button type="button" id="edit-select-on-map-btn" class="w-full btn-primary text-white px-4 py-2 rounded-lg font-medium">
                            📍 Cambiar Ubicación en el Mapa
                        </button>
                        <div id="edit-coordinates-display" class="text-sm text-gray-600 text-center">
                            Lat: <span id="edit-selected-lat">-</span>, Lng: <span id="edit-selected-lng">-</span>
                        </div>
                        <input type="hidden" id="edit-client-lat" name="clientLat">
                        <input type="hidden" id="edit-client-lng" name="clientLng">
                    </div>
                </div>
                <div class="col-span-1 flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-edit-client-btn" class="px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-[#E0E0E0] transition">Cancelar</button>
                    <button type="submit" class="px-6 py-2 rounded-full font-semibold btn-primary text-white">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN DE FIREBASE
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAb5XiSi95-GKDyvWHV70He4u6DhsYOQBQ",
            authDomain: "malanguisimas-clientes.firebaseapp.com",
            databaseURL: "https://malanguisimas-clientes-default-rtdb.firebaseio.com",
            projectId: "malanguisimas-clientes",
            storageBucket: "malanguisimas-clientes.firebasestorage.app",
            messagingSenderId: "376896001019",
            appId: "1:376896001019:web:205b0e52064fb5082fb15e",
            measurementId: "G-2XQ829M20T"
        };
        
        // ==========================================
        // VARIABLES GLOBALES DE FIREBASE
        // ==========================================
        
        let firebaseApp = null;
        let database = null;
        let auth = null;
        let currentUser = null;
        let isOfflineMode = false;
        let syncListeners = [];
        
        // ==========================================
        // INICIALIZACIÓN DE FIREBASE
        // ==========================================
        
        function initializeFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                auth = firebase.auth();
                
                // Autenticación anónima
                auth.signInAnonymously()
                    .then(() => {
                        console.log('✅ Usuario autenticado en Firebase');
                        currentUser = auth.currentUser;
                        setupRealtimeSync();
                        showNotification('✅ Conectado a Firebase - Sincronización habilitada', 'success');
                        updateSyncStatus('synced');
                    })
                    .catch(error => {
                        console.error('Error de autenticación:', error);
                        showNotification('Error al conectar con Firebase: ' + error.message, 'error');
                        isOfflineMode = true;
                        updateSyncStatus('offline');
                    });
                
                // Escuchar cambios de estado de conexión
                firebase.database().ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        updateSyncStatus('synced');
                    } else {
                        updateSyncStatus('offline');
                    }
                });
                
            } catch (error) {
                console.error('Error al inicializar Firebase:', error);
                showNotification('Error al conectar con Firebase', 'error');
                isOfflineMode = true;
                updateSyncStatus('offline');
            }
        }
        
        // Función para configurar sincronización en tiempo real
        function setupRealtimeSync() {
            if (!database || !currentUser) return;
            
            // Escuchar cambios en clientes
            const clientsRef = database.ref('clients');
            syncListeners.push(clientsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    individualClients = Object.values(data);
                    nextIndividualClientId = Math.max(...individualClients.map(c => c.id || 0)) + 1;
                    
                    // Actualizar UI si está en la vista de clientes
                    if (document.querySelector('[data-tab="clients"]').classList.contains('active')) {
                        if (viewSegmentsBtn.classList.contains('active')) {
                            renderSegmentCards(segmentDefinitions);
                        } else {
                            renderIndividualClientList(individualClients, sortBySelect.value, sortOrderSelect.value);
                        }
                    }
                    
                    updateDashboard();
                    renderPortfolioChart();
                    renderSalesBySegmentChart();
                    if (mapInstance) updateMapMarkers();
                }
            }));
            
            // Escuchar cambios en ventas
            const salesRef = database.ref('sales');
            syncListeners.push(salesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    sales = Object.values(data);
                    nextSaleId = Math.max(...sales.map(s => s.id || 0)) + 1;
                    renderSales();
                    updateDashboard();
                    renderSalesBySegmentChart();
                    renderSalesTrendChart();
                }
            }));
            
            // Escuchar cambios en entregas
            const deliveriesRef = database.ref('deliveries');
            syncListeners.push(deliveriesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    deliveries = Object.values(data);
                    nextDeliveryId = Math.max(...deliveries.map(d => d.id || 0)) + 1;
                    renderDeliveries();
                    updateDashboard();
                }
            }));
            
            // Escuchar cambios en recordatorios
            const remindersRef = database.ref('reminders');
            syncListeners.push(remindersRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    weeklyReminders = Object.values(data);
                    nextReminderId = Math.max(...weeklyReminders.map(r => r.id || 0)) + 1;
                    renderReminders();
                }
            }));
            
            // Escuchar cambios en interacciones
            const interactionsRef = database.ref('interactions');
            syncListeners.push(interactionsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    interactions = Object.values(data);
                    nextInteractionId = Math.max(...interactions.map(i => i.id || 0)) + 1;
                    
                    // Actualizar timeline si está visible
                    const selectedClientId = crmClientSelect.value;
                    if (selectedClientId) {
                        showInteractionsTimeline(selectedClientId);
                    }
                }
            }));
            
            // Configurar presencia de usuarios
            setupUserPresence();
        }
        
        // Función para configurar presencia de usuarios
        function setupUserPresence() {
            if (!database || !currentUser) return;
            
            const myUserRef = database.ref(`presence/${currentUser.uid}`);
            const myConnectionsRef = database.ref(`presence/${currentUser.uid}/connections`);
            
            // Generar color aleatorio para el avatar
            const colors = ['#8D6E63', '#A1887F', '#FFAB91', '#22c55e', '#3b82f6', '#a855f7'];
            const userColor = colors[Math.floor(Math.random() * colors.length)];
            
            // Cuando el usuario se conecta
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    const con = myConnectionsRef.push();
                    con.onDisconnect().remove();
                    con.set({
                        lastSeen: firebase.database.ServerValue.TIMESTAMP,
                        userColor: userColor
                    });
                }
            });
            
            // Escuchar usuarios activos
            database.ref('presence').on('value', (snapshot) => {
                const users = snapshot.val();
                if (users) {
                    const activeUsersContainer = document.getElementById('active-users');
                    const userCount = Object.keys(users).length;
                    
                    if (userCount > 1) {
                        activeUsersContainer.classList.remove('hidden');
                        activeUsersContainer.innerHTML = `
                            <span class="text-sm text-white/80">${userCount} usuarios activos</span>
                            ${Object.entries(users).slice(0, 3).map(([uid, user]) => {
                                const connections = user.connections || {};
                                const lastConnection = Object.values(connections)[0];
                                const color = lastConnection?.userColor || '#8D6E63';
                                return `<div class="user-avatar" style="background-color: ${color};">
                                    ${uid.substring(0, 2).toUpperCase()}
                                </div>`;
                            }).join('')}
                            ${userCount > 3 ? `<div class="user-avatar bg-gray-600">+${userCount - 3}</div>` : ''}
                        `;
                    } else {
                        activeUsersContainer.classList.add('hidden');
                    }
                }
            });
        }
        
        // Función para guardar datos en Firebase
        function saveToFirebase(collection, data) {
            if (database && !isOfflineMode) {
                updateSyncStatus('syncing');
                database.ref(`${collection}/${data.id}`).set(data)
                    .then(() => {
                        updateSyncStatus('synced');
                    })
                    .catch(error => {
                        console.error('Error al guardar en Firebase:', error);
                        updateSyncStatus('offline');
                        // Guardar localmente como fallback
                        saveData(collection, data);
                    });
            } else {
                // Modo offline - guardar solo localmente
                saveData(collection, data);
            }
        }
        
        // Función para actualizar datos en Firebase
        function updateInFirebase(collection, id, data) {
            if (database && !isOfflineMode) {
                updateSyncStatus('syncing');
                database.ref(`${collection}/${id}`).update(data)
                    .then(() => {
                        updateSyncStatus('synced');
                    })
                    .catch(error => {
                        console.error('Error al actualizar en Firebase:', error);
                        updateSyncStatus('offline');
                        // Actualizar localmente como fallback
                        updateData(collection, id, data);
                    });
            } else {
                // Modo offline - actualizar solo localmente
                updateData(collection, id, data);
            }
        }
        
        // Función para eliminar datos de Firebase
        function deleteFromFirebase(collection, id) {
            if (database && !isOfflineMode) {
                updateSyncStatus('syncing');
                database.ref(`${collection}/${id}`).remove()
                    .then(() => {
                        updateSyncStatus('synced');
                    })
                    .catch(error => {
                        console.error('Error al eliminar de Firebase:', error);
                        updateSyncStatus('offline');
                        // Eliminar localmente como fallback
                        deleteData(collection, id);
                    });
            } else {
                // Modo offline - eliminar solo localmente
                deleteData(collection, id);
            }
        }
        
        // Función para actualizar estado de sincronización
        function updateSyncStatus(status) {
            const syncStatusEl = document.getElementById('sync-status');
            const syncTextEl = document.getElementById('sync-text');
            
            syncStatusEl.className = `sync-status ${status}`;
            
            switch(status) {
                case 'synced':
                    syncTextEl.textContent = 'Sincronizado';
                    break;
                case 'syncing':
                    syncTextEl.innerHTML = '<span class="syncing-icon">🔄</span> Sincronizando...';
                    break;
                case 'offline':
                    syncTextEl.textContent = 'Sin conexión';
                    break;
            }
        }
        
        // ==========================================
        // FUNCIONES DE PERSISTENCIA DE DATOS (LOCAL)
        // ==========================================
        
        function saveData(collection, data) {
            try {
                const localData = JSON.parse(localStorage.getItem(`malanguisimas_${collection}`) || '[]');
                localData.push(data);
                localStorage.setItem(`malanguisimas_${collection}`, JSON.stringify(localData));
            } catch (error) {
                console.error('Error al guardar datos localmente:', error);
            }
        }

        function loadData(collection) {
            try {
                return JSON.parse(localStorage.getItem(`malanguisimas_${collection}`) || '[]');
            } catch (error) {
                console.error('Error al cargar datos locales:', error);
                return [];
            }
        }

        function updateData(collection, id, data) {
            try {
                const localData = JSON.parse(localStorage.getItem(`malanguisimas_${collection}`) || '[]');
                const index = localData.findIndex(item => item.id === id);
                if (index !== -1) {
                    localData[index] = { ...localData[index], ...data };
                    localStorage.setItem(`malanguisimas_${collection}`, JSON.stringify(localData));
                }
            } catch (error) {
                console.error('Error al actualizar datos localmente:', error);
            }
        }

        function deleteData(collection, id) {
            try {
                const localData = JSON.parse(localStorage.getItem(`malanguisimas_${collection}`) || '[]');
                const filteredData = localData.filter(item => item.id !== id);
                localStorage.setItem(`malanguisimas_${collection}`, JSON.stringify(filteredData));
            } catch (error) {
                console.error('Error al eliminar datos localmente:', error);
            }
        }

        // ==========================================
        // INICIALIZACIÓN CON MANEJO DE ERRORES
        // ==========================================
        document.addEventListener('DOMContentLoaded', function () {
            try {
                console.log('Iniciando aplicación Malanguísimas...');
                
                // Inicializar Firebase
                initializeFirebase();
                
                // Inicializar la aplicación
                initializeApp();
                
            } catch (error) {
                console.error('Error crítico al iniciar la aplicación:', error);
                document.getElementById('loading-overlay').innerHTML = `
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-red-600 mb-4">Error al cargar la aplicación</h2>
                        <p class="text-gray-600 mb-4">Por favor, recarga la página.</p>
                        <pre class="text-left bg-gray-100 p-4 rounded max-w-2xl mx-auto text-sm">${error.stack}</pre>
                    </div>
                `;
            }
        });

        // ==========================================
        // FUNCIÓN PRINCIPAL DE INICIALIZACIÓN
        // ==========================================
        function initializeApp() {
            console.log('Cargando componentes de la aplicación...');
            
            // ==========================================
            // DATOS INICIALES
            // ==========================================
            
            // Definiciones de segmentos estratégicos
            let segmentDefinitions = [
                {
                    id: 1, category: 'Tiendas de Productos Naturales y Gourmet',
                    priority: 'Alta', priorityLevel: 3, salesPotential: 8, brandAlignment: 9, icon: '🌿',
                    analysis: 'Se especializan en productos orgánicos, naturales y artesanales. Sus clientes son conscientes de la salud, buscan calidad y están dispuestos a pagar un precio más alto por productos con valor.',
                    positioning: 'Posicionar como un snack premium, orgánico y exótico. Resaltar los beneficios del taro y el aceite de coco, y la producción artesanal.',
                    strategy: 'Priorizar una ubicación destacada en estantes. Ofrecer degustaciones en tienda y realizar co-marketing. Comunicar la historia detrás de Malanguísimas para conectar con la filosofía de la tienda.'
                },
                {
                    id: 2, category: 'Gimnasios y Centros de Bienestar',
                    priority: 'Alta', priorityLevel: 3, salesPotential: 7, brandAlignment: 8, icon: '🏋️',
                    analysis: 'Atraen a personas enfocadas en salud, rendimiento físico y bienestar. Muchos ofrecen asesoramiento nutricional, creando un público receptivo a snacks saludables.',
                    positioning: 'Comunicar como un "snack funcional" o un "impulso de energía natural". Enfatizar "grasas saludables del coco", "sin culpa" e ideal para antes o después de entrenar.',
                    strategy: 'Colocación en mostradores de recepción o máquinas expendedoras. Colaborar con entrenadores o nutricionistas para que recomienden el producto. La información nutricional debe ser clara y visible.'
                },
                {
                    id: 3, category: 'Cafeterías y Establecimientos de Comida',
                    priority: 'Media', priorityLevel: 2, salesPotential: 6, brandAlignment: 7, icon: '☕',
                    analysis: 'Son lugares de socialización con una demanda creciente de opciones de comida saludable y de calidad. Los clientes valoran la experiencia y productos novedosos.',
                    positioning: 'Presentar como un snack gourmet, saludable y distintivo. Perfecto para acompañar un café o como una alternativa a la bollería tradicional.',
                    strategy: 'Ofrecer como un extra en el mostrador o como acompañamiento en el menú. Proveer muestras al personal para que puedan recomendarlo activamente. Usar exhibidores de marca para aumentar la visibilidad.'
                },
                {
                    id: 4, category: 'Abarrotes',
                    priority: 'Media', priorityLevel: 2, salesPotential: 9, brandAlignment: 4, icon: '🏪',
                    analysis: 'Tiendas de barrio con alta rotación y clientela local. La decisión de compra se basa principalmente en el precio, la conveniencia y la confianza en el tendero.',
                    positioning: 'Accesible, local y una alternativa más saludable a los chips tradicionales. Destacar el "sabor auténtico" o "hecho en Chiapas" para generar conexión local.',
                    strategy: 'Ofrecer precios competitivos y formatos de menor tamaño. Construir una relación personal sólida con los propietarios, ya que son influenciadores clave en la comunidad. Venta al por mayor con márgenes atractivos.'
                },
                {
                    id: 5, category: 'Centros Infantiles y Recreativos',
                    priority: 'Media', priorityLevel: 2, salesPotential: 5, brandAlignment: 7, icon: '🧸',
                    analysis: 'Centros enfocados en el desarrollo infantil, donde los padres buscan activamente opciones de alimentos saludables y naturales para sus hijos.',
                    positioning: 'Una alternativa de snack saludable, divertido y natural para niños. Enfatizar "sin aditivos", "ingredientes naturales" y como una opción superior a las papas fritas tradicionales.',
                    strategy: 'Venta directa a los centros para sus programas de snacks. Desarrollar empaques atractivos para niños y porciones controladas que den tranquilidad a los padres.'
                },
                {
                    id: 6, category: 'Hoteles',
                    priority: 'Baja', priorityLevel: 1, salesPotential: 4, brandAlignment: 6, icon: '🏨',
                    analysis: 'Los huéspedes (turistas y viajeros de negocios) buscan conveniencia y a menudo están abiertos a probar productos locales y de calidad premium.',
                    positioning: 'Un snack único, local y premium para viajeros. Enfatizar el "sabor de Chiapas" y la calidad de los ingredientes.',
                    strategy: 'Buscar inclusión en minibares, tiendas de regalos del hotel o en el snack bar. El empaque debe ser elegante y en formatos individuales.'
                },
                {
                    id: 7, category: 'Farmacias',
                    priority: 'Baja', priorityLevel: 1, salesPotential: 3, brandAlignment: 5, icon: '💊',
                    analysis: 'Aunque su foco son los medicamentos, muchas farmacias han expandido su oferta a productos de bienestar y snacks, capturando compras por impulso.',
                    positioning: 'Una compra impulsiva saludable en un entorno de bienestar. Una alternativa natural a los snacks convencionales.',
                    strategy: 'Colocación estratégica en el mostrador de caja. Enfocarse en farmacias que ya tengan una sección de productos naturales o de bienestar.'
                },
                {
                    id: 8, category: 'Otros (Viajes)',
                    priority: 'Baja', priorityLevel: 1, salesPotential: 2, brandAlignment: 4, icon: '✈️',
                    analysis: 'Negocios relacionados con el turismo. Los viajeros buscan snacks convenientes, ligeros y fáciles de transportar para sus trayectos.',
                    positioning: 'El snack de viaje perfecto: conveniente, ligero y distintivo.',
                    strategy: 'Establecer alianzas con agencias para ofrecer paquetes pequeños a sus clientes o explorar la venta en puntos de conveniencia en aeropuertos.'
                },
                {
                    id: 9, category: 'Otros (Educación)',
                    priority: 'Baja', priorityLevel: 1, salesPotential: 2, brandAlignment: 5, icon: '🎓',
                    analysis: 'Las instituciones educativas con campus físicos suelen tener cafeterías o máquinas expendedoras para estudiantes y personal.',
                    positioning: 'Un snack saludable y conveniente para una pausa entre clases.',
                    strategy: 'Requiere clarificación sobre su presencia local. Si existe, contactar directamente con los servicios de alimentación del campus.'
                },
                {
                    id: 10, category: 'Requiere Clarificación',
                    priority: 'Baja', priorityLevel: 0, salesPotential: 1, brandAlignment: 1, icon: '❓',
                    analysis: 'La información sobre estos clientes es ambigua o contradictoria. No es posible definir una estrategia clara sin una investigación adicional.',
                    positioning: 'N/A',
                    strategy: 'Acción crítica: Contactar directamente para clarificar la naturaleza exacta del negocio y evaluar su verdadero potencial. Hasta entonces, no se deben asignar recursos significativos.'
                }
            ];

            // Clientes individuales iniciales con coordenadas aproximadas para Tuxtla Gutiérrez
            let individualClients = [
                { id: 1, name: 'Oskandre', location: 'Tuxtla Gutiérrez', category: 'Tiendas de Productos Naturales y Gourmet', lat: 16.7530, lng: -93.1150, lastPurchase: '2024-01-15', totalPurchases: 15000 },
                { id: 2, name: 'Amanecer Natural Calza', location: 'Tuxtla Gutiérrez', category: 'Tiendas de Productos Naturales y Gourmet', lat: 16.7689, lng: -93.0952, lastPurchase: '2024-01-20', totalPurchases: 12000 },
                { id: 3, name: 'Arbolaria', location: 'Tuxtla Gutiérrez', category: 'Tiendas de Productos Naturales y Gourmet', lat: 16.7601, lng: -93.1234, lastPurchase: '2024-01-18', totalPurchases: 18000 },
                { id: 4, name: 'SMART HEALTH', location: 'Tuxtla Gutiérrez', category: 'Tiendas de Productos Naturales y Gourmet', lat: 16.7485, lng: -93.1103, lastPurchase: '2024-01-22', totalPurchases: 20000 },
                { id: 5, name: 'EnForme Barre', location: 'Tuxtla Gutiérrez', category: 'Gimnasios y Centros de Bienestar', lat: 16.7712, lng: -93.1087, lastPurchase: '2024-01-19', totalPurchases: 8000 },
                { id: 6, name: 'MOA Gym', location: 'Tuxtla Gutiérrez', category: 'Gimnasios y Centros de Bienestar', lat: 16.7423, lng: -93.1178, lastPurchase: '2024-01-21', totalPurchases: 9500 },
                { id: 7, name: 'VEGO GYM', location: 'Tuxtla Gutiérrez', category: 'Gimnasios y Centros de Bienestar', lat: 16.7567, lng: -93.0987, lastPurchase: '2024-01-17', totalPurchases: 7500 },
                { id: 8, name: 'ITRO GYM', location: 'Tuxtla Gutiérrez', category: 'Gimnasios y Centros de Bienestar', lat: 16.7389, lng: -93.1267, lastPurchase: '2024-01-23', totalPurchases: 6000 },
                { id: 9, name: 'GK GYM SPORT', location: 'Tuxtla Gutiérrez', category: 'Gimnasios y Centros de Bienestar', lat: 16.7645, lng: -93.1145, lastPurchase: '2024-01-16', totalPurchases: 8500 },
                { id: 10, name: 'Tempo Studio', location: 'Tuxtla Gutiérrez', category: 'Gimnasios y Centros de Bienestar', lat: 16.7502, lng: -93.1056, lastPurchase: '2024-01-24', totalPurchases: 11000 },
                { id: 11, name: 'Café New York', location: 'Tuxtla Gutiérrez', category: 'Cafeterías y Establecimientos de Comida', lat: 16.7543, lng: -93.1198, lastPurchase: '2024-01-20', totalPurchases: 5000 },
                { id: 12, name: 'Cafetería Tec de Mty', location: 'Tuxtla Gutiérrez', category: 'Cafeterías y Establecimientos de Comida', lat: 16.7678, lng: -93.1023, lastPurchase: '2024-01-22', totalPurchases: 6500 },
                { id: 13, name: 'FunCake', location: 'Tuxtla Gutiérrez', category: 'Cafeterías y Establecimientos de Comida', lat: 16.7456, lng: -93.1134, lastPurchase: '2024-01-19', totalPurchases: 4500 },
                { id: 14, name: 'Abarrotes "La unión" 1 Y 2', location: 'Tuxtla Gutiérrez', category: 'Abarrotes', lat: 16.7398, lng: -93.1089, lastPurchase: '2024-01-25', totalPurchases: 3000 },
                { id: 15, name: 'Abarrotes Laureles', location: 'Tuxtla Gutiérrez', category: 'Abarrotes', lat: 16.7612, lng: -93.1212, lastPurchase: '2024-01-21', totalPurchases: 2500 },
                { id: 16, name: 'Abarrotes Rubí', location: 'Tuxtla Gutiérrez', category: 'Abarrotes', lat: 16.7523, lng: -93.0945, lastPurchase: '2024-01-18', totalPurchases: 2800 },
                { id: 17, name: 'Abarrotes "Romer"', location: 'Tuxtla Gutiérrez', category: 'Abarrotes', lat: 16.7701, lng: -93.1167, lastPurchase: '2024-01-23', totalPurchases: 3200 },
                { id: 18, name: 'KIDS CENTER', location: 'Tuxtla Gutiérrez', category: 'Centros Infantiles y Recreativos', lat: 16.7467, lng: -93.1045, lastPurchase: '2024-01-20', totalPurchases: 4000 },
                { id: 19, name: 'Real de Dos', location: 'Tuxtla Gutiérrez', category: 'Hoteles', lat: 16.7589, lng: -93.1123, lastPurchase: '2024-01-15', totalPurchases: 1500 },
                { id: 20, name: 'MAXIFARMACIAS', location: 'Tuxtla Gutiérrez', category: 'Farmacias', lat: 16.7434, lng: -93.1234, lastPurchase: '2024-01-17', totalPurchases: 1000 },
                { id: 21, name: 'Empaca y vuela', location: 'Tuxtla Gutiérrez', category: 'Otros (Viajes)', lat: 16.7634, lng: -93.0978, lastPurchase: '2024-01-19', totalPurchases: 800 },
                { id: 22, name: 'ASHER-EBC', location: 'Tuxtla Gutiérrez', category: 'Otros (Educación)', lat: 16.7378, lng: -93.1156, lastPurchase: '2024-01-16', totalPurchases: 500 },
                { id: 23, name: 'NOSOTROS', location: 'Tuxtla Gutiérrez', category: 'Requiere Clarificación', lat: 16.7556, lng: -93.1078, lastPurchase: '2024-01-14', totalPurchases: 0 },
                { id: 24, name: 'TIA YUYI', location: 'Tuxtla Gutiérrez', category: 'Requiere Clarificación', lat: 16.7490, lng: -93.1189, lastPurchase: '2024-01-13', totalPurchases: 0 }
            ];

            // Datos de recomendaciones
            const recommendationsData = [
                {
                    title: "🎯 Enfoque Estratégico",
                    content: "Prioriza a los clientes que mejor se alinean con la marca Malanguísimas (saludable, natural, gourmet), como tiendas de productos naturales y gimnasios. Concentrar tus recursos en estos segmentos de alta prioridad te permitirá construir una marca fuerte y maximizar los márgenes de beneficio."
                },
                {
                    title: "💰 Adaptabilidad del Producto y Precio",
                    content: "Ajusta la presentación y el precio a cada canal. Considera empaques más pequeños y precios competitivos para abarrotes, manteniendo un enfoque premium para tiendas gourmet y hoteles. Esta flexibilidad es clave para ser relevante en diversos entornos comerciales."
                },
                {
                    title: "🤝 Construcción de Relaciones",
                    content: "El éxito, especialmente en canales como los abarrotes, depende de la confianza. Invierte tiempo en construir relaciones personales sólidas con los dueños de los negocios. Escucha sus necesidades y pídeles retroalimentación; es invaluable."
                },
                {
                    title: "📊 Decisiones Basadas en Datos",
                    content: "Monitorea constantemente los datos de ventas por cada segmento. ¿Qué estrategias funcionan mejor? ¿Dónde hay mayor rentabilidad? Usa esta información para refinar tu enfoque y asignar tus recursos de manera más inteligente."
                },
                {
                    title: "🚀 Implementación y Monitoreo",
                    content: "Realiza programas piloto para probar nuevas ideas (empaques, promociones) antes de un lanzamiento a gran escala. Establece un bucle de retroalimentación para escuchar a tus clientes y mantente al día con las tendencias del mercado local en Tuxtla Gutiérrez."
                },
                {
                    title: "⚡ Acciones Inmediatas Críticas",
                    content: "Contacta directamente a los clientes 'NOSOTROS' y 'TIA YUYI' para clarificar su tipo de negocio. Sin esta información, es imposible definir una estrategia. Si se confirma que 'ASHER-EBC' no tiene sede local, debe ser retirado de la lista activa."
                }
            ];

            // Arrays para datos adicionales
            let deliveries = [];
            let weeklyReminders = [];
            let sales = [];
            let interactions = [];

            // Metas mensuales
            const monthlyGoals = {
                sales: 50000,
                newClients: 10,
                deliveries: 100
            };

            // Contadores para IDs
            let nextIndividualClientId = individualClients.length > 0 ? Math.max(...individualClients.map(c => c.id)) + 1 : 1;
            let nextSegmentDefinitionId = segmentDefinitions.length > 0 ? Math.max(...segmentDefinitions.map(s => s.id)) + 1 : 1;
            let nextDeliveryId = 1;
            let nextReminderId = 1;
            let nextSaleId = 1;
            let nextInteractionId = 1;

            // ==========================================
            // REFERENCIAS A ELEMENTOS DOM
            // ==========================================
            
            const grid = document.getElementById('client-grid');
            const segmentModal = document.getElementById('segment-modal');
            const modalContent = document.getElementById('modal-content');
            const closeSegmentModalBtn = document.getElementById('close-segment-modal-btn');
            const filterBtns = document.querySelectorAll('.filter-btn');
            const segmentFilterContainer = document.getElementById('segment-filter-container');

            const addClientBtn = document.getElementById('add-client-btn');
            const addClientModal = document.getElementById('add-client-modal');
            const closeAddClientModalBtn = document.getElementById('close-add-client-modal-btn');
            const cancelAddClientBtn = document.getElementById('cancel-add-client-btn');
            const addClientForm = document.getElementById('add-client-form');

            const newClientNameInput = document.getElementById('new-client-name');
            const newClientLocationInput = document.getElementById('new-client-location');
            const newClientCategorySelect = document.getElementById('new-client-category');
            const newCategoryInput = document.getElementById('new-category-input');
            const newClientLatInput = document.getElementById('new-client-lat');
            const newClientLngInput = document.getElementById('new-client-lng');

            // Elementos del modal de selección de mapa
            const mapSelectorModal = document.getElementById('map-selector-modal');
            const cancelMapSelection = document.getElementById('cancel-map-selection');
            const confirmMapSelection = document.getElementById('confirm-map-selection');
            const selectOnMapBtn = document.getElementById('select-on-map-btn');
            const coordinatesDisplay = document.getElementById('coordinates-display');
            const selectedLatSpan = document.getElementById('selected-lat');
            const selectedLngSpan = document.getElementById('selected-lng');

            // Elementos del modal de edición
            const editClientModal = document.getElementById('edit-client-modal');
            const closeEditClientModalBtn = document.getElementById('close-edit-client-modal-btn');
            const cancelEditClientBtn = document.getElementById('cancel-edit-client-btn');
            const editClientForm = document.getElementById('edit-client-form');
            const editClientIdInput = document.getElementById('edit-client-id');
            const editClientNameInput = document.getElementById('edit-client-name');
            const editClientLocationInput = document.getElementById('edit-client-location');
            const editClientCategorySelect = document.getElementById('edit-client-category');
            const editClientLatInput = document.getElementById('edit-client-lat');
            const editClientLngInput = document.getElementById('edit-client-lng');
            const editSelectOnMapBtn = document.getElementById('edit-select-on-map-btn');
            const editSelectedLatSpan = document.getElementById('edit-selected-lat');
            const editSelectedLngSpan = document.getElementById('edit-selected-lng');

            const viewSegmentsBtn = document.getElementById('view-segments-btn');
            const viewIndividualClientsBtn = document.getElementById('view-individual-clients-btn');

            const sortOptionsContainer = document.getElementById('sort-options-container');
            const sortBySelect = document.getElementById('sort-by');
            const sortOrderSelect = document.getElementById('sort-order');

            const deliveryClientSelect = document.getElementById('delivery-client-select');
            const deliveryDateInput = document.getElementById('delivery-date');
            const addDeliveryBtn = document.getElementById('add-delivery-btn');
            const deliveryList = document.getElementById('delivery-list');

            const reminderSegmentSelect = document.getElementById('reminder-segment-select');
            const reminderDaySelect = document.getElementById('reminder-day');
            const reminderTextInput = document.getElementById('reminder-text');
            const addReminderBtn = document.getElementById('add-reminder-btn');
            const reminderList = document.getElementById('reminder-list');

            // Elementos de tabs
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            // Elementos de ventas
            const addSaleBtn = document.getElementById('add-sale-btn');
            const addSaleModal = document.getElementById('add-sale-modal');
            const closeAddSaleModalBtn = document.getElementById('close-add-sale-modal-btn');
            const cancelAddSaleBtn = document.getElementById('cancel-add-sale-btn');
            const addSaleForm = document.getElementById('add-sale-form');
            const saleClientSelect = document.getElementById('sale-client');
            const saleAmountInput = document.getElementById('sale-amount');
            const saleProductsInput = document.getElementById('sale-products');
            const saleDateInput = document.getElementById('sale-date');

            // Elementos de CRM
            const crmClientSelect = document.getElementById('crm-client-select');
            const addInteractionBtn = document.getElementById('add-interaction-btn');
            const addInteractionModal = document.getElementById('add-interaction-modal');
            const closeAddInteractionModalBtn = document.getElementById('close-add-interaction-modal-btn');
            const cancelAddInteractionBtn = document.getElementById('cancel-add-interaction-btn');
            const addInteractionForm = document.getElementById('add-interaction-form');
            const clientInfoSection = document.getElementById('client-info-section');

            // Instancias de gráficas
            let portfolioChartInstance = null;
            let matrixChartInstance = null;
            let salesBySegmentChartInstance = null;
            let salesTrendChartInstance = null;
            let mapInstance = null;
            let locationSelectorMap = null;
            let locationMarker = null;
            let tempLocation = null;
            let isEditingClient = false;

            // ==========================================
            // SISTEMA DE TABS
            // ==========================================
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    // Actualizar botones
                    tabBtns.forEach(b => {
                        b.classList.remove('active', 'bg-white/20');
                        b.classList.add('bg-white/10');
                    });
                    btn.classList.add('active', 'bg-white/20');
                    btn.classList.remove('bg-white/10');
                    
                    // Mostrar contenido del tab
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${targetTab}-tab`).classList.add('active');

                    // Inicializar mapa si es necesario
                    if (targetTab === 'map' && !mapInstance) {
                        setTimeout(() => initializeMap(), 100);
                    }
                });
            });

            // ==========================================
            // SISTEMA DE NOTIFICACIONES
            // ==========================================
            
            function showNotification(message, type = 'success') {
                const notificationContainer = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type} p-4 rounded-lg flex items-center gap-3`;
                
                let icon = '';
                switch(type) {
                    case 'success': icon = '✅'; break;
                    case 'error': icon = '❌'; break;
                    case 'warning': icon = '⚠️'; break;
                    case 'info': icon = 'ℹ️'; break;
                }
                
                notification.innerHTML = `
                    <span class="text-2xl">${icon}</span>
                    <p class="font-medium">${message}</p>
                `;
                
                notificationContainer.appendChild(notification);
                
                // Remover la notificación después de 3 segundos
                setTimeout(() => {
                    notification.style.animation = 'slideInRight 0.5s ease-out reverse';
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }, 3000);
            }

            // ==========================================
            // FUNCIONES UTILITARIAS
            // ==========================================
            
            // Obtener definición de segmento por categoría
            const getSegmentDefinition = (categoryName) => {
                return segmentDefinitions.find(s => s.category.toLowerCase() === categoryName.toLowerCase());
            };

            // Formatear moneda
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('es-MX', {
                    style: 'currency',
                    currency: 'MXN'
                }).format(amount);
            };

            // Formatear fecha
            const formatDate = (dateString) => {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString('es-MX', options);
            };

            // Formatear fecha y hora
            const formatDateTime = (dateString) => {
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return new Date(dateString).toLocaleDateString('es-MX', options);
            };

            // Calcular días desde última compra
            const daysSinceLastPurchase = (lastPurchaseDate) => {
                const last = new Date(lastPurchaseDate);
                const today = new Date();
                const diffTime = Math.abs(today - last);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };

            // ==========================================
            // FUNCIONES DE RENDERIZADO
            // ==========================================
            
            // Renderizar tarjetas de segmentos
            const renderSegmentCards = (data) => {
                grid.innerHTML = '';
                grid.classList.remove('flex', 'flex-col', 'space-y-4', 'client-list-container');
                grid.classList.add('grid', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-8');

                data.forEach(segment => {
                    const card = document.createElement('div');
                    card.className = 'client-card segment-card glass-card rounded-xl shadow-lg p-6 flex flex-col items-center text-center transition-all transform hover:scale-105';
                    card.dataset.priority = segment.priority;

                    let priorityClass = '';
                    let priorityBg = '';
                    switch(segment.priority) {
                        case 'Alta': 
                            priorityClass = 'text-green-800'; 
                            priorityBg = 'bg-gradient-to-r from-green-400 to-green-500';
                            break;
                        case 'Media': 
                            priorityClass = 'text-yellow-800'; 
                            priorityBg = 'bg-gradient-to-r from-yellow-400 to-yellow-500';
                            break;
                        case 'Baja': 
                            priorityClass = 'text-red-800'; 
                            priorityBg = 'bg-gradient-to-r from-red-400 to-red-500';
                            break;
                        default: 
                            priorityClass = 'text-gray-800'; 
                            priorityBg = 'bg-gradient-to-r from-gray-400 to-gray-500';
                            break;
                    }
                    
                    // Calcular ventas del segmento
                    const segmentSales = sales
                        .filter(s => {
                            const client = individualClients.find(c => c.id === s.clientId);
                            return client && client.category === segment.category;
                        })
                        .reduce((sum, s) => sum + s.amount, 0);
                    
                    card.innerHTML = `
                        <div class="text-6xl mb-4 animate-pulse">${segment.icon}</div>
                        <h3 class="text-xl font-bold mb-2 h-14 flex items-center">${segment.category}</h3>
                        <span class="px-4 py-2 text-sm font-semibold rounded-full text-white ${priorityBg} mb-4 shadow-md">Prioridad ${segment.priority}</span>
                        <p class="text-gray-600 flex-grow mb-2">${segment.analysis.substring(0, 100)}...</p>
                        <p class="text-sm font-semibold text-[#8D6E63] mb-4">Ventas: ${formatCurrency(segmentSales)}</p>
                        <button class="view-details-btn btn-primary text-white px-6 py-2 rounded-full font-semibold w-full" data-category="${segment.category}">Ver Detalles</button>
                    `;
                    grid.appendChild(card);

                    card.querySelector('.view-details-btn').addEventListener('click', () => showSegmentModal(segment.category));
                });
            };

            // Renderizar lista de clientes individuales
            const renderIndividualClientList = (data, sortBy = 'name', sortOrder = 'asc') => {
                grid.innerHTML = '';
                grid.classList.remove('grid', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-8');
                grid.classList.add('flex', 'flex-col', 'space-y-3', 'client-list-container');

                if (data.length === 0) {
                    grid.innerHTML = '<p class="text-center text-gray-600 col-span-full">No hay clientes individuales registrados aún.</p>';
                    return;
                }

                // Ordenar los datos
                const sortedData = [...data].sort((a, b) => {
                    let valA = a[sortBy].toLowerCase();
                    let valB = b[sortBy].toLowerCase();

                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

                sortedData.forEach(client => {
                    const daysSince = daysSinceLastPurchase(client.lastPurchase);
                    let statusColor = 'text-green-600';
                    if (daysSince > 30) statusColor = 'text-red-600';
                    else if (daysSince > 15) statusColor = 'text-yellow-600';

                    const listItem = document.createElement('div');
                    listItem.className = 'individual-client-item new-item';
                    listItem.onclick = () => {
                        // Cambiar a tab CRM y mostrar cliente
                        document.querySelector('[data-tab="crm"]').click();
                        setTimeout(() => {
                            crmClientSelect.value = client.id;
                            crmClientSelect.dispatchEvent(new Event('change'));
                        }, 100);
                    };
                    
                    listItem.innerHTML = `
                        <div class="text-left flex-grow">
                            <p class="text-lg font-semibold text-[#4E443A]">${client.name}</p>
                            <p class="text-sm text-gray-600">${client.location} • ${client.category}</p>
                            <p class="text-xs ${statusColor}">Última compra: hace ${daysSince} días</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-semibold text-[#8D6E63]">${formatCurrency(client.totalPurchases)}</span>
                            <button class="btn-primary px-3 py-1 rounded-full text-sm text-white" onclick="event.stopPropagation(); editClient(${client.id})">
                                ✏️
                            </button>
                            <button class="delete-btn btn-danger px-3 py-1 rounded-full text-sm" onclick="event.stopPropagation(); deleteClient(${client.id})">
                                🗑️
                            </button>
                        </div>
                    `;
                    grid.appendChild(listItem);
                });
            };
            
            // Mostrar modal de detalles del segmento
            const showSegmentModal = (categoryName) => {
                const segment = getSegmentDefinition(categoryName);
                if (!segment) return;

                const clientsInSegment = individualClients.filter(c => c.category.toLowerCase() === categoryName.toLowerCase());
                const clientsList = clientsInSegment.length > 0 
                    ? `<ul class="list-disc list-inside space-y-1">${clientsInSegment.map(c => 
                        `<li class="flex justify-between items-center">
                            <span>${c.name} (${c.location})</span>
                            <button onclick="editClient(${c.id})" class="text-[#8D6E63] hover:text-[#6D5E53] ml-2">
                                ✏️
                            </button>
                        </li>`
                      ).join('')}</ul>` 
                    : '<p class="text-gray-500 italic">No hay clientes individuales registrados en este segmento aún.</p>';

                let priorityBg = '';
                switch(segment.priority) {
                    case 'Alta': priorityBg = 'bg-gradient-to-r from-green-400 to-green-500'; break;
                    case 'Media': priorityBg = 'bg-gradient-to-r from-yellow-400 to-yellow-500'; break;
                    case 'Baja': priorityBg = 'bg-gradient-to-r from-red-400 to-red-500'; break;
                    default: priorityBg = 'bg-gradient-to-r from-gray-400 to-gray-500'; break;
                }
                
                modalContent.innerHTML = `
                    <div class="flex items-start mb-6">
                        <div class="text-6xl mr-6 animate-pulse">${segment.icon}</div>
                        <div class="flex-grow">
                            <h2 class="text-3xl font-bold text-[#8D6E63]">${segment.category}</h2>
                            <span class="px-4 py-2 text-sm font-semibold rounded-full text-white ${priorityBg} mt-2 inline-block shadow-md">Prioridad ${segment.priority}</span>
                            <p class="text-gray-600 mt-2">Potencial: ${segment.salesPotential}/10 • Alineación: ${segment.brandAlignment}/10</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="glass-card p-4 rounded-lg">
                            <h4 class="text-xl font-semibold mb-2 text-[#A1887F] flex items-center gap-2">
                                <span>📊</span> Análisis del Segmento
                            </h4>
                            <p class="text-gray-700">${segment.analysis}</p>
                        </div>
                        <div class="glass-card p-4 rounded-lg">
                            <h4 class="text-xl font-semibold mb-2 text-[#A1887F] flex items-center gap-2">
                                <span>🎯</span> Posicionamiento Estratégico
                            </h4>
                            <p class="text-gray-700">${segment.positioning}</p>
                        </div>
                        <div class="glass-card p-4 rounded-lg">
                            <h4 class="text-xl font-semibold mb-2 text-[#A1887F] flex items-center gap-2">
                                <span>💡</span> Estrategia de Venta
                            </h4>
                            <p class="text-gray-700">${segment.strategy}</p>
                        </div>
                        <div class="glass-card p-4 rounded-lg">
                            <h4 class="text-xl font-semibold mb-2 text-[#A1887F] flex items-center gap-2">
                                <span>👥</span> Clientes Individuales en este Segmento
                            </h4>
                            ${clientsList}
                        </div>
                    </div>
                `;
                segmentModal.classList.add('show');
            };

            // Ocultar modal de detalles del segmento
            const hideSegmentModal = () => {
                segmentModal.classList.remove('show');
            };

            // Filtrar tarjetas de segmentos
            const filterSegments = (filter) => {
                document.querySelectorAll('.client-card').forEach(card => {
                    if (filter === 'all' || card.dataset.priority === filter) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
            };
            
            // Actualizar métricas generales
            const updateOverviewMetrics = () => {
                const totalClientsCount = individualClients.length;
                const totalSegmentsCount = segmentDefinitions.length;
                const highPrioritySegmentsCount = segmentDefinitions.filter(s => s.priority === 'Alta').length;

                if (document.getElementById('totalClients')) {
                    document.getElementById('totalClients').textContent = totalClientsCount;
                }
                if (document.getElementById('totalSegments')) {
                    document.getElementById('totalSegments').textContent = totalSegmentsCount;
                }
                if (document.getElementById('highPrioritySegments')) {
                    document.getElementById('highPrioritySegments').textContent = highPrioritySegmentsCount;
                }
            };

            // Actualizar dashboard
            const updateDashboard = () => {
                // Calcular métricas
                const today = new Date();
                const startOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                const todaySales = sales
                    .filter(s => new Date(s.date).toDateString() === today.toDateString())
                    .reduce((sum, s) => sum + s.amount, 0);
                
                const weekSales = sales
                    .filter(s => new Date(s.date) >= startOfWeek)
                    .reduce((sum, s) => sum + s.amount, 0);
                
                const monthSales = sales
                    .filter(s => new Date(s.date) >= startOfMonth)
                    .reduce((sum, s) => sum + s.amount, 0);
                
                const avgTicket = sales.length > 0 ? monthSales / sales.length : 0;
                
                const activeClients = individualClients.filter(c => {
                    const daysSince = daysSinceLastPurchase(c.lastPurchase);
                    return daysSince <= 30;
                }).length;
                
                const goalPercentage = (monthSales / monthlyGoals.sales) * 100;
                
                // Actualizar KPIs
                document.getElementById('monthly-sales').textContent = formatCurrency(monthSales);
                document.getElementById('avg-ticket').textContent = formatCurrency(avgTicket);
                document.getElementById('active-clients').textContent = activeClients;
                document.getElementById('goal-percentage').textContent = Math.round(goalPercentage) + '%';
                
                // Actualizar ventas en tab de ventas
                document.getElementById('today-sales').textContent = formatCurrency(todaySales);
                document.getElementById('week-sales').textContent = formatCurrency(weekSales);
                document.getElementById('month-sales').textContent = formatCurrency(monthSales);
                
                // Actualizar barras de progreso
                const salesProgress = Math.min((monthSales / monthlyGoals.sales) * 100, 100);
                const newClientsProgress = Math.min((individualClients.length / monthlyGoals.newClients) * 100, 100);
                const deliveriesProgress = Math.min((deliveries.length / monthlyGoals.deliveries) * 100, 100);
                
                document.getElementById('sales-progress').textContent = `${formatCurrency(monthSales)} / ${formatCurrency(monthlyGoals.sales)}`;
                document.getElementById('sales-progress-bar').style.width = salesProgress + '%';
                
                document.getElementById('clients-progress').textContent = `${individualClients.length} / ${monthlyGoals.newClients}`;
                document.getElementById('clients-progress-bar').style.width = newClientsProgress + '%';
                
                document.getElementById('deliveries-progress').textContent = `${deliveries.length} / ${monthlyGoals.deliveries}`;
                document.getElementById('deliveries-progress-bar').style.width = deliveriesProgress + '%';
            };

            // ==========================================
            // FUNCIONES DE GRÁFICAS
            // ==========================================
            
            // Renderizar gráfica de distribución de portafolio
            const renderPortfolioChart = () => {
                if (portfolioChartInstance) {
                    portfolioChartInstance.destroy();
                }

                const portfolioCtx = document.getElementById('portfolioDistributionChart').getContext('2d');
                const categoryCounts = individualClients.reduce((acc, curr) => {
                    const category = curr.category;
                    if (!acc[category]) {
                        acc[category] = 0;
                    }
                    acc[category]++;
                    return acc;
                }, {});

                portfolioChartInstance = new Chart(portfolioCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categoryCounts),
                        datasets: [{
                            label: 'Número de Clientes Individuales',
                            data: Object.values(categoryCounts),
                            backgroundColor: [
                                '#8D6E63', '#A1887F', '#BCAAA4', '#FFAB91',
                                '#FFCCBC', '#FFE0B2', '#FFD54F', '#A5D6A7', '#81C784',
                                '#FDD835', '#FFF176', '#BA68C8', '#E1BEE7', '#90CAF9'
                            ],
                            borderColor: '#FDF8F0',
                            borderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' cliente(s)';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            // Renderizar gráfica de ventas por segmento
            const renderSalesBySegmentChart = () => {
                if (salesBySegmentChartInstance) {
                    salesBySegmentChartInstance.destroy();
                }

                const ctx = document.getElementById('salesBySegmentChart').getContext('2d');
                
                // Calcular ventas por segmento
                const salesBySegment = {};
                segmentDefinitions.forEach(seg => {
                    salesBySegment[seg.category] = 0;
                });
                
                sales.forEach(sale => {
                    const client = individualClients.find(c => c.id === sale.clientId);
                    if (client && salesBySegment.hasOwnProperty(client.category)) {
                        salesBySegment[client.category] += sale.amount;
                    }
                });

                salesBySegmentChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(salesBySegment).slice(0, 5), // Top 5 segmentos
                        datasets: [{
                            label: 'Ventas por Segmento',
                            data: Object.values(salesBySegment).slice(0, 5),
                            backgroundColor: [
                                '#8D6E63', '#A1887F', '#BCAAA4', '#FFAB91', '#FFCCBC'
                            ],
                            borderColor: '#FDF8F0',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            },
                            x: {
                                display: false
                            }
                        }
                    }
                });
            };

            // Renderizar gráfica de tendencia de ventas
            const renderSalesTrendChart = () => {
                if (salesTrendChartInstance) {
                    salesTrendChartInstance.destroy();
                }

                const ctx = document.getElementById('salesTrendChart').getContext('2d');
                
                // Generar datos de los últimos 30 días
                const last30Days = [];
                const salesData = [];
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    last30Days.push(dateStr);
                    
                    const daySales = sales
                        .filter(s => s.date.startsWith(dateStr))
                        .reduce((sum, s) => sum + s.amount, 0);
                    
                    salesData.push(daySales);
                }

                salesTrendChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last30Days.map(d => formatDate(d)),
                        datasets: [{
                            label: 'Ventas Diarias',
                            data: salesData,
                            borderColor: '#8D6E63',
                            backgroundColor: 'rgba(141, 110, 99, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            };

            // ==========================================
            // FUNCIONES DE MAPA
            // ==========================================
            
            const initializeMap = () => {
                // Inicializar mapa centrado en Tuxtla Gutiérrez
                mapInstance = L.map('clients-map').setView([16.7516, -93.1029], 13);
                
                // Añadir capa de tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(mapInstance);
                
                // Añadir marcadores de clientes
                updateMapMarkers();
            };

            // Inicializar mapa selector de ubicación
            const initializeLocationSelector = () => {
                if (!locationSelectorMap) {
                    locationSelectorMap = L.map('location-selector-map').setView([16.7516, -93.1029], 13);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(locationSelectorMap);
                    
                    // Evento de clic en el mapa
                    locationSelectorMap.on('click', (e) => {
                        const { lat, lng } = e.latlng;
                        
                        // Remover marcador anterior si existe
                        if (locationMarker) {
                            locationSelectorMap.removeLayer(locationMarker);
                        }
                        
                        // Agregar nuevo marcador
                        locationMarker = L.marker([lat, lng]).addTo(locationSelectorMap);
                        
                        // Añadir un pequeño efecto de rebote al marcador
                        if (locationMarker._icon) {
                            locationMarker._icon.style.animation = 'pulse 0.5s';
                        }
                        
                        // Guardar ubicación temporal
                        tempLocation = { lat, lng };
                        
                        // Actualizar UI
                        const instruction = isEditingClient ? 
                            '✅ Nueva ubicación seleccionada. Confirma para actualizar.' : 
                            '✅ Ubicación seleccionada. Confirma para guardar.';
                        document.getElementById('map-instructions').textContent = instruction;
                        confirmMapSelection.disabled = false;
                        confirmMapSelection.classList.add('animate-pulse');
                        confirmMapSelection.innerHTML = '✅ Confirmar Nueva Ubicación';
                    });
                }
                
                // Restaurar texto del botón por defecto
                confirmMapSelection.innerHTML = '✅ Confirmar Ubicación';
                
                // Centrar el mapa y asegurar renderizado correcto
                setTimeout(() => {
                    if (locationSelectorMap) {
                        locationSelectorMap.invalidateSize();
                    }
                }, 100);
            };

            // Abrir selector de mapa
            selectOnMapBtn.addEventListener('click', () => {
                isEditingClient = false;
                mapSelectorModal.classList.add('show');
                initializeLocationSelector();
                
                // Asegurar que el mapa se renderice correctamente
                setTimeout(() => {
                    locationSelectorMap.invalidateSize();
                    
                    // Para nuevo cliente, empezar sin marcador y centrar en Tuxtla
                    if (locationMarker) {
                        locationSelectorMap.removeLayer(locationMarker);
                        locationMarker = null;
                    }
                    tempLocation = null;
                    locationSelectorMap.setView([16.7516, -93.1029], 13);
                    document.getElementById('map-instructions').textContent = 'Haz clic en el mapa para seleccionar la ubicación';
                    confirmMapSelection.disabled = true;
                    confirmMapSelection.classList.remove('animate-pulse');
                    confirmMapSelection.innerHTML = '✅ Confirmar Ubicación';
                }, 200);
            });

            editSelectOnMapBtn.addEventListener('click', () => {
                isEditingClient = true;
                mapSelectorModal.classList.add('show');
                initializeLocationSelector();
                
                // Asegurar que el mapa se renderice correctamente
                setTimeout(() => {
                    locationSelectorMap.invalidateSize();
                    
                    // Si ya hay coordenadas, mostrar marcador
                    const lat = parseFloat(editClientLatInput.value);
                    const lng = parseFloat(editClientLngInput.value);
                    if (lat && lng) {
                        if (locationMarker) {
                            locationSelectorMap.removeLayer(locationMarker);
                        }
                        locationMarker = L.marker([lat, lng]).addTo(locationSelectorMap);
                        locationSelectorMap.setView([lat, lng], 15);
                        
                        // Guardar la ubicación actual como temporal para permitir cambios
                        tempLocation = { lat, lng };
                        
                        // Actualizar UI para mostrar que ya hay una ubicación pero se puede cambiar
                        document.getElementById('map-instructions').textContent = '📍 Ubicación actual. Haz clic en otro lugar para cambiarla.';
                        confirmMapSelection.disabled = false;
                        confirmMapSelection.classList.remove('animate-pulse'); // Quitar animación para la ubicación actual
                        confirmMapSelection.innerHTML = '✅ Mantener Ubicación Actual';
                    }
                }, 200);
            });

            // Confirmar selección de ubicación
            confirmMapSelection.addEventListener('click', () => {
                if (tempLocation) {
                    const isNewLocation = isEditingClient && 
                        (parseFloat(editClientLatInput.value) !== tempLocation.lat || 
                         parseFloat(editClientLngInput.value) !== tempLocation.lng);
                    
                    if (isEditingClient) {
                        editClientLatInput.value = tempLocation.lat;
                        editClientLngInput.value = tempLocation.lng;
                        editSelectedLatSpan.textContent = tempLocation.lat.toFixed(6);
                        editSelectedLngSpan.textContent = tempLocation.lng.toFixed(6);
                        
                        if (isNewLocation) {
                            showNotification('📍 Ubicación actualizada correctamente', 'success');
                        }
                    } else {
                        newClientLatInput.value = tempLocation.lat;
                        newClientLngInput.value = tempLocation.lng;
                        selectedLatSpan.textContent = tempLocation.lat.toFixed(6);
                        selectedLngSpan.textContent = tempLocation.lng.toFixed(6);
                        coordinatesDisplay.classList.remove('hidden');
                        
                        showNotification('📍 Ubicación seleccionada correctamente', 'success');
                    }
                    
                    // Cerrar modal
                    mapSelectorModal.classList.remove('show');
                    tempLocation = null;
                    if (locationMarker) {
                        locationSelectorMap.removeLayer(locationMarker);
                        locationMarker = null;
                    }
                    document.getElementById('map-instructions').textContent = 'Haz clic en el mapa para seleccionar la ubicación';
                    confirmMapSelection.disabled = true;
                    confirmMapSelection.classList.remove('animate-pulse');
                    confirmMapSelection.innerHTML = '✅ Confirmar Ubicación';
                }
            });

            // Cancelar selección de mapa
            cancelMapSelection.addEventListener('click', () => {
                mapSelectorModal.classList.remove('show');
                
                // Limpiar estado
                tempLocation = null;
                if (locationMarker) {
                    locationSelectorMap.removeLayer(locationMarker);
                    locationMarker = null;
                }
                
                // Restaurar UI
                document.getElementById('map-instructions').textContent = 'Haz clic en el mapa para seleccionar la ubicación';
                confirmMapSelection.disabled = true;
                confirmMapSelection.classList.remove('animate-pulse');
                confirmMapSelection.innerHTML = '✅ Confirmar Ubicación';
            });

            mapSelectorModal.addEventListener('click', (e) => {
                if (e.target === mapSelectorModal) {
                    mapSelectorModal.classList.remove('show');
                    tempLocation = null;
                    if (locationMarker) {
                        locationSelectorMap.removeLayer(locationMarker);
                        locationMarker = null;
                    }
                    document.getElementById('map-instructions').textContent = 'Haz clic en el mapa para seleccionar la ubicación';
                    confirmMapSelection.disabled = true;
                    confirmMapSelection.classList.remove('animate-pulse');
                    confirmMapSelection.innerHTML = '✅ Confirmar Ubicación';
                }
            });

            const updateMapMarkers = (filter = 'all') => {
                if (!mapInstance) return;
                
                // Limpiar marcadores existentes
                mapInstance.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        mapInstance.removeLayer(layer);
                    }
                });
                
                // Filtrar clientes
                let filteredClients = individualClients;
                if (filter === 'Alta') {
                    filteredClients = individualClients.filter(c => {
                        const segment = getSegmentDefinition(c.category);
                        return segment && segment.priority === 'Alta';
                    });
                } else if (filter === 'pending') {
                    filteredClients = individualClients.filter(c => {
                        const daysSince = daysSinceLastPurchase(c.lastPurchase);
                        return daysSince > 15;
                    });
                }
                
                // Añadir marcadores
                let bounds = [];
                filteredClients.forEach(client => {
                    const segment = getSegmentDefinition(client.category);
                    let markerColor = 'gray';
                    
                    if (segment) {
                        switch(segment.priority) {
                            case 'Alta': markerColor = 'green'; break;
                            case 'Media': markerColor = 'orange'; break;
                            case 'Baja': markerColor = 'red'; break;
                        }
                    }
                    
                    const marker = L.marker([client.lat, client.lng]).addTo(mapInstance);
                    marker.bindPopup(`
                        <div class="p-2">
                            <h4 class="font-bold">${client.name}</h4>
                            <p class="text-sm">${client.category}</p>
                            <p class="text-sm">Última compra: ${formatDate(client.lastPurchase)}</p>
                            <p class="text-sm font-semibold mb-2">${formatCurrency(client.totalPurchases)}</p>
                            <button onclick="editClient(${client.id})" class="btn-primary text-white px-3 py-1 rounded text-xs w-full">
                                ✏️ Editar Cliente
                            </button>
                        </div>
                    `);
                    
                    bounds.push([client.lat, client.lng]);
                });
                
                // Ajustar vista del mapa
                if (bounds.length > 0) {
                    mapInstance.fitBounds(bounds, { padding: [50, 50] });
                }
                
                // Actualizar estadísticas
                document.getElementById('map-clients-count').textContent = filteredClients.length;
                document.getElementById('map-zones-count').textContent = 
                    new Set(filteredClients.map(c => c.location)).size;
            };

            // Event listeners para filtros del mapa
            document.querySelectorAll('.map-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.map-filter-btn').forEach(b => {
                        b.classList.remove('active', 'bg-[#8D6E63]', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    btn.classList.add('active', 'bg-[#8D6E63]', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    
                    updateMapMarkers(btn.dataset.filter);
                });
            });

            // Optimizar ruta (simulación)
            document.getElementById('optimize-route-btn').addEventListener('click', () => {
                showNotification('Calculando ruta óptima...', 'success');
                setTimeout(() => {
                    document.getElementById('map-distance').textContent = '42.7 km';
                    showNotification('Ruta optimizada: ahorro de 15% en distancia', 'success');
                }, 1500);
            });

            // ==========================================
            // FUNCIONES DE FORMULARIOS
            // ==========================================
            
            // Poblar select de categorías con segmentos
            function populateCategorySelect() {
                // Para el formulario de agregar cliente - mostrar segmentos con información completa
                newClientCategorySelect.innerHTML = `
                    <option value="">Selecciona un segmento</option>
                    ${segmentDefinitions.map(seg => {
                        let priorityEmoji = '';
                        switch(seg.priority) {
                            case 'Alta': priorityEmoji = '🟢'; break;
                            case 'Media': priorityEmoji = '🟡'; break;
                            case 'Baja': priorityEmoji = '🔴'; break;
                            default: priorityEmoji = '⚪'; break;
                        }
                        return `<option value="${seg.category}">${seg.icon} ${seg.category} ${priorityEmoji} (${seg.priority})</option>`;
                    }).join('')}
                    <option value="new">➕ Crear nuevo segmento...</option>
                `;
                
                // Para el formulario de editar cliente - mostrar segmentos con información completa
                editClientCategorySelect.innerHTML = `
                    <option value="">Selecciona un segmento</option>
                    ${segmentDefinitions.map(seg => {
                        let priorityEmoji = '';
                        switch(seg.priority) {
                            case 'Alta': priorityEmoji = '🟢'; break;
                            case 'Media': priorityEmoji = '🟡'; break;
                            case 'Baja': priorityEmoji = '🔴'; break;
                            default: priorityEmoji = '⚪'; break;
                        }
                        return `<option value="${seg.category}">${seg.icon} ${seg.category} ${priorityEmoji} (${seg.priority})</option>`;
                    }).join('')}
                `;
            }

            // Manejar cambio de categoría
            newClientCategorySelect.addEventListener('change', (e) => {
                if (e.target.value === 'new') {
                    newCategoryInput.classList.remove('hidden');
                    newCategoryInput.required = true;
                } else {
                    newCategoryInput.classList.add('hidden');
                    newCategoryInput.required = false;
                    newCategoryInput.value = '';
                }
            });

            // Poblar select de clientes para entregas
            function populateDeliveryClientSelect() {
                deliveryClientSelect.innerHTML = '<option value="">Selecciona un cliente</option>';
                const sortedClients = [...individualClients].sort((a, b) => a.name.localeCompare(b.name));
                sortedClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} (${client.category})`;
                    deliveryClientSelect.appendChild(option);
                });
            }

            // Poblar select de clientes para ventas
            function populateSaleClientSelect() {
                saleClientSelect.innerHTML = '<option value="">Selecciona un cliente</option>';
                const sortedClients = [...individualClients].sort((a, b) => a.name.localeCompare(b.name));
                sortedClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} (${client.category})`;
                    saleClientSelect.appendChild(option);
                });
            }

            // Poblar select de clientes para CRM
            function populateCRMClientSelect() {
                crmClientSelect.innerHTML = '<option value="">Selecciona un cliente para ver su historial</option>';
                const sortedClients = [...individualClients].sort((a, b) => a.name.localeCompare(b.name));
                sortedClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} (${client.category})`;
                    crmClientSelect.appendChild(option);
                });
            }

            // Poblar select de segmentos para recordatorios
            function populateReminderSegmentSelect() {
                reminderSegmentSelect.innerHTML = '<option value="">Selecciona un segmento</option>';
                const sortedSegments = [...segmentDefinitions].sort((a, b) => a.category.localeCompare(b.category));
                sortedSegments.forEach(segment => {
                    const option = document.createElement('option');
                    option.value = segment.id;
                    option.textContent = segment.category;
                    reminderSegmentSelect.appendChild(option);
                });
            }

            // ==========================================
            // FUNCIONES DE ENTREGAS Y RECORDATORIOS
            // ==========================================
            
            // Renderizar lista de entregas
            function renderDeliveries() {
                deliveryList.innerHTML = '';
                if (deliveries.length === 0) {
                    deliveryList.innerHTML = '<p class="text-gray-600 text-center">No hay entregas registradas</p>';
                    return;
                }
                const sortedDeliveries = [...deliveries].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedDeliveries.forEach(delivery => {
                    const div = document.createElement('div');
                    div.className = 'delivery-item glass-card p-3 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center new-item';
                    div.innerHTML = `
                        <span class="text-gray-700">${delivery.clientName} - ${delivery.date}</span>
                        <button class="delete-btn btn-danger px-2 py-1 rounded-full text-xs" onclick="deleteDelivery(${delivery.id})">
                            🗑️
                        </button>
                    `;
                    deliveryList.appendChild(div);
                });
            }

            // Renderizar lista de recordatorios
            function renderReminders() {
                reminderList.innerHTML = '';
                if (weeklyReminders.length === 0) {
                    reminderList.innerHTML = '<p class="text-gray-600 text-center">No hay recordatorios</p>';
                    return;
                }
                const dayOrder = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                const sortedReminders = [...weeklyReminders].sort((a, b) => {
                    const dayA = dayOrder.indexOf(a.day);
                    const dayB = dayOrder.indexOf(b.day);
                    if (dayA === dayB) {
                        return a.segmentCategory.localeCompare(b.segmentCategory);
                    }
                    return dayA - dayB;
                });

                sortedReminders.forEach(reminder => {
                    const div = document.createElement('div');
                    div.className = 'reminder-item glass-card p-3 rounded-lg shadow-sm border border-gray-200 new-item';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-gray-700 font-medium">${reminder.day} - ${reminder.segmentCategory}</p>
                                <p class="text-gray-600 text-sm italic">"${reminder.text}"</p>
                            </div>
                            <button class="delete-btn btn-danger px-2 py-1 rounded-full text-xs ml-2" onclick="deleteReminder(${reminder.id})">
                                🗑️
                            </button>
                        </div>
                    `;
                    reminderList.appendChild(div);
                });
            }

            // Renderizar lista de ventas
            function renderSales() {
                const salesList = document.getElementById('sales-list');
                salesList.innerHTML = '';
                
                if (sales.length === 0) {
                    salesList.innerHTML = '<p class="text-gray-600 text-center">No hay ventas registradas</p>';
                    return;
                }
                
                const sortedSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedSales.forEach(sale => {
                    const client = individualClients.find(c => c.id === sale.clientId);
                    const div = document.createElement('div');
                    div.className = 'sale-item glass-card p-3 rounded-lg shadow-sm border border-gray-200 new-item';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <p class="text-gray-700 font-medium">${client ? client.name : 'Cliente Desconocido'}</p>
                                <p class="text-sm text-gray-600">${formatDateTime(sale.date)}</p>
                                ${sale.products ? `<p class="text-sm text-gray-500">${sale.products}</p>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-[#22c55e]">${formatCurrency(sale.amount)}</span>
                                <button class="delete-btn btn-danger px-2 py-1 rounded-full text-xs" onclick="deleteSale(${sale.id})">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
                    salesList.appendChild(div);
                });
            }

            // ==========================================
            // FUNCIONES DE CRM
            // ==========================================
            
            // Mostrar información del cliente en CRM
            function showClientCRM(clientId) {
                const client = individualClients.find(c => c.id == clientId);
                if (!client) {
                    clientInfoSection.classList.add('hidden');
                    addInteractionBtn.disabled = true;
                    return;
                }
                
                clientInfoSection.classList.remove('hidden');
                addInteractionBtn.disabled = false;
                
                // Información del cliente
                const clientDetails = document.getElementById('client-details');
                const segment = getSegmentDefinition(client.category);
                
                clientDetails.innerHTML = `
                    <div class="space-y-2">
                        <p><span class="font-medium">Nombre:</span> ${client.name}</p>
                        <p><span class="font-medium">Ubicación:</span> ${client.location}</p>
                        <p><span class="font-medium">Categoría:</span> ${client.category}</p>
                        <p><span class="font-medium">Prioridad:</span> 
                            <span class="px-2 py-1 text-xs rounded-full ${
                                segment.priority === 'Alta' ? 'bg-green-100 text-green-800' :
                                segment.priority === 'Media' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }">${segment.priority}</span>
                        </p>
                        <p><span class="font-medium">Última compra:</span> ${formatDate(client.lastPurchase)}</p>
                    </div>
                `;
                
                // Métricas del cliente
                const clientSales = sales.filter(s => s.clientId === client.id);
                const totalSales = clientSales.reduce((sum, s) => sum + s.amount, 0);
                const avgPurchase = clientSales.length > 0 ? totalSales / clientSales.length : 0;
                const clientInteractions = interactions.filter(i => i.clientId === client.id);
                const avgSatisfaction = clientInteractions
                    .filter(i => i.satisfaction)
                    .reduce((sum, i, _, arr) => sum + i.satisfaction / arr.length, 0);
                
                const clientMetrics = document.getElementById('client-metrics');
                clientMetrics.innerHTML = `
                    <div class="space-y-2">
                        <p><span class="font-medium">Total de compras:</span> ${formatCurrency(totalSales)}</p>
                        <p><span class="font-medium">Número de compras:</span> ${clientSales.length}</p>
                        <p><span class="font-medium">Ticket promedio:</span> ${formatCurrency(avgPurchase)}</p>
                        <p><span class="font-medium">Interacciones:</span> ${clientInteractions.length}</p>
                        <p><span class="font-medium">Satisfacción promedio:</span> ${avgSatisfaction ? '⭐'.repeat(Math.round(avgSatisfaction)) : 'N/A'}</p>
                    </div>
                `;
                
                // Timeline de interacciones
                showInteractionsTimeline(clientId);
            }

            // Mostrar timeline de interacciones
            function showInteractionsTimeline(clientId) {
                const timeline = document.getElementById('interactions-timeline');
                const clientInteractions = interactions.filter(i => i.clientId == clientId);
                const clientSales = sales.filter(s => s.clientId == clientId);
                const clientDeliveries = deliveries.filter(d => {
                    const client = individualClients.find(c => c.id == clientId);
                    return client && d.clientName === client.name;
                });
                
                // Combinar todos los eventos
                const allEvents = [
                    ...clientInteractions.map(i => ({ ...i, type: 'interaction', eventType: i.type })),
                    ...clientSales.map(s => ({ ...s, type: 'sale' })),
                    ...clientDeliveries.map(d => ({ ...d, type: 'delivery' }))
                ].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (allEvents.length === 0) {
                    timeline.innerHTML = '<p class="text-gray-600 text-center">No hay interacciones registradas</p>';
                    return;
                }
                
                timeline.innerHTML = '';
                allEvents.forEach(event => {
                    const div = document.createElement('div');
                    div.className = 'timeline-item';
                    
                    let icon = '';
                    let title = '';
                    let content = '';
                    let color = '';
                    
                    if (event.type === 'interaction') {
                        switch(event.eventType) {
                            case 'call': icon = '📞'; title = 'Llamada'; break;
                            case 'visit': icon = '🏪'; title = 'Visita'; break;
                            case 'message': icon = '💬'; title = 'Mensaje'; break;
                            case 'email': icon = '📧'; title = 'Email'; break;
                            case 'complaint': icon = '😟'; title = 'Queja'; break;
                            case 'compliment': icon = '😊'; title = 'Felicitación'; break;
                        }
                        content = event.notes;
                        if (event.satisfaction) {
                            content += ` (${('⭐').repeat(event.satisfaction)})`;
                        }
                        color = 'bg-blue-100';
                    } else if (event.type === 'sale') {
                        icon = '💰';
                        title = 'Venta';
                        content = `${formatCurrency(event.amount)}`;
                        if (event.products) content += ` - ${event.products}`;
                        color = 'bg-green-100';
                    } else if (event.type === 'delivery') {
                        icon = '📦';
                        title = 'Entrega';
                        content = 'Producto entregado';
                        color = 'bg-yellow-100';
                    }
                    
                    div.innerHTML = `
                        <div class="timeline-dot"></div>
                        <div class="${color} p-3 rounded-lg">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">${icon}</span>
                                <span class="font-semibold">${title}</span>
                                <span class="text-xs text-gray-500">${formatDateTime(event.date)}</span>
                            </div>
                            <p class="text-sm text-gray-700">${content}</p>
                        </div>
                    `;
                    
                    timeline.appendChild(div);
                });
            }

            // ==========================================
            // FUNCIONES DE ELIMINACIÓN Y EDICIÓN
            // ==========================================
            
            window.deleteClient = function(clientId) {
                if (confirm('¿Estás seguro de que quieres eliminar este cliente?')) {
                    individualClients = individualClients.filter(c => c.id !== clientId);
                    
                    // Eliminar de Firebase
                    deleteFromFirebase('clients', clientId);
                    
                    // Actualizar vista actual
                    if (viewIndividualClientsBtn.classList.contains('active')) {
                        renderIndividualClientList(individualClients, sortBySelect.value, sortOrderSelect.value);
                    }
                    
                    // Actualizar otras vistas
                    updateOverviewMetrics();
                    updateDashboard();
                    renderPortfolioChart();
                    renderSalesBySegmentChart();
                    populateDeliveryClientSelect();
                    populateSaleClientSelect();
                    populateCRMClientSelect();
                    
                    showNotification('Cliente eliminado exitosamente', 'success');
                }
            };

            window.editClient = function(clientId) {
                const client = individualClients.find(c => c.id === clientId);
                if (!client) return;
                
                // Llenar el formulario con los datos del cliente
                editClientIdInput.value = client.id;
                editClientNameInput.value = client.name;
                editClientLocationInput.value = client.location;
                editClientCategorySelect.value = client.category;
                editClientLatInput.value = client.lat;
                editClientLngInput.value = client.lng;
                editSelectedLatSpan.textContent = client.lat.toFixed(6);
                editSelectedLngSpan.textContent = client.lng.toFixed(6);
                
                // Mostrar modal
                editClientModal.classList.add('show');
            };

            window.deleteDelivery = function(deliveryId) {
                deliveries = deliveries.filter(d => d.id !== deliveryId);
                deleteFromFirebase('deliveries', deliveryId);
                renderDeliveries();
                updateDashboard();
                showNotification('Entrega eliminada exitosamente', 'success');
            };

            window.deleteReminder = function(reminderId) {
                weeklyReminders = weeklyReminders.filter(r => r.id !== reminderId);
                deleteFromFirebase('reminders', reminderId);
                renderReminders();
                showNotification('Recordatorio eliminado exitosamente', 'success');
            };

            window.deleteSale = function(saleId) {
                sales = sales.filter(s => s.id !== saleId);
                deleteFromFirebase('sales', saleId);
                renderSales();
                updateDashboard();
                renderSalesBySegmentChart();
                renderSalesTrendChart();
                showNotification('Venta eliminada exitosamente', 'success');
            };

            // ==========================================
            // EVENT LISTENERS
            // ==========================================
            
            // Modal de detalles del segmento
            closeSegmentModalBtn.addEventListener('click', hideSegmentModal);
            segmentModal.addEventListener('click', (e) => {
                if (e.target === segmentModal) {
                    hideSegmentModal();
                }
            });

            // Botones de filtro (solo para vista de segmentos)
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.replace('active-filter', 'inactive-filter'));
                    btn.classList.replace('inactive-filter', 'active-filter');
                    filterSegments(btn.dataset.filter);
                });
            });

            // Modal para añadir cliente individual
            addClientBtn.addEventListener('click', () => {
                addClientModal.classList.add('show');
            });

            closeAddClientModalBtn.addEventListener('click', () => {
                addClientModal.classList.remove('show');
                addClientForm.reset();
            });

            cancelAddClientBtn.addEventListener('click', () => {
                addClientModal.classList.remove('show');
                addClientForm.reset();
            });

            addClientModal.addEventListener('click', (e) => {
                if (e.target === addClientModal) {
                    addClientModal.classList.remove('show');
                    addClientForm.reset();
                }
            });

            // Formulario para añadir cliente
            addClientForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const clientName = newClientNameInput.value.trim();
                const clientLocation = newClientLocationInput.value.trim();
                let clientCategory = newClientCategorySelect.value;
                
                if (!clientName || !clientLocation || !clientCategory) {
                    showNotification('Por favor, completa todos los campos requeridos', 'warning');
                    return;
                }
                
                // Si seleccionó nueva categoría, usar el valor del input
                if (clientCategory === 'new') {
                    clientCategory = newCategoryInput.value.trim();
                    if (!clientCategory) {
                        showNotification('Por favor, ingresa el nombre del nuevo segmento', 'warning');
                        return;
                    }
                }

                // Obtener coordenadas o usar las predeterminadas de Tuxtla
                let lat = parseFloat(newClientLatInput.value);
                let lng = parseFloat(newClientLngInput.value);
                
                if (!lat || !lng) {
                    // Si no se seleccionó ubicación, usar coordenadas aleatorias cercanas a Tuxtla
                    lat = 16.7516 + (Math.random() - 0.5) * 0.05;
                    lng = -93.1029 + (Math.random() - 0.5) * 0.05;
                    showNotification('⚠️ Se asignó una ubicación aproximada en Tuxtla. Puedes editarla después desde el mapa.', 'warning');
                }

                // Verificar si existe el segmento
                let existingSegment = getSegmentDefinition(clientCategory);

                if (!existingSegment) {
                    // Crear nuevo segmento si no existe
                    existingSegment = {
                        id: nextSegmentDefinitionId++,
                        category: clientCategory,
                        priority: 'Requiere Clarificación',
                        priorityLevel: 0,
                        salesPotential: 1,
                        brandAlignment: 1,
                        icon: '❓',
                        analysis: 'Este es un nuevo segmento de cliente generado automáticamente. Se recomienda revisar y definir su análisis, posicionamiento y estrategia.',
                        positioning: 'Aún no definido.',
                        strategy: 'Aún no definida.'
                    };
                    segmentDefinitions.push(existingSegment);
                    segmentDefinitions.sort((a, b) => b.priorityLevel - a.priorityLevel);
                }

                // Añadir cliente individual
                const newClient = {
                    id: nextIndividualClientId++,
                    name: clientName,
                    location: clientLocation,
                    category: clientCategory,
                    lat: lat,
                    lng: lng,
                    lastPurchase: new Date().toISOString().split('T')[0],
                    totalPurchases: 0
                };
                
                individualClients.push(newClient);
                
                // Guardar en Firebase
                saveToFirebase('clients', newClient);

                // Actualizar UI según la vista activa
                if (viewSegmentsBtn.classList.contains('active')) {
                    renderSegmentCards(segmentDefinitions);
                    filterSegments(document.querySelector('.filter-btn.active-filter').dataset.filter);
                } else {
                    renderIndividualClientList(individualClients, sortBySelect.value, sortOrderSelect.value);
                }
                
                // Actualizar todas las vistas
                updateOverviewMetrics();
                updateDashboard();
                renderPortfolioChart();
                renderSalesBySegmentChart();
                populateCategorySelect();
                populateDeliveryClientSelect();
                populateSaleClientSelect();
                populateCRMClientSelect();
                populateReminderSegmentSelect();
                
                // Actualizar mapa si está visible
                if (mapInstance) {
                    updateMapMarkers();
                }

                // Cerrar modal y resetear formulario
                addClientModal.classList.remove('show');
                addClientForm.reset();
                newCategoryInput.classList.add('hidden');
                coordinatesDisplay.classList.add('hidden');
                newClientLatInput.value = '';
                newClientLngInput.value = '';
                
                // Mostrar notificación
                showNotification(`Cliente "${clientName}" añadido exitosamente`, 'success');
            });

            // Modal para editar cliente
            closeEditClientModalBtn.addEventListener('click', () => {
                editClientModal.classList.remove('show');
                editClientForm.reset();
            });

            cancelEditClientBtn.addEventListener('click', () => {
                editClientModal.classList.remove('show');
                editClientForm.reset();
            });

            editClientModal.addEventListener('click', (e) => {
                if (e.target === editClientModal) {
                    editClientModal.classList.remove('show');
                    editClientForm.reset();
                }
            });

            // Formulario para editar cliente
            editClientForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const clientId = parseInt(editClientIdInput.value);
                const clientIndex = individualClients.findIndex(c => c.id === clientId);
                
                if (clientIndex !== -1) {
                    // Actualizar datos del cliente
                    individualClients[clientIndex] = {
                        ...individualClients[clientIndex],
                        name: editClientNameInput.value.trim(),
                        location: editClientLocationInput.value.trim(),
                        category: editClientCategorySelect.value,
                        lat: parseFloat(editClientLatInput.value),
                        lng: parseFloat(editClientLngInput.value)
                    };
                    
                    // Actualizar en Firebase
                    updateInFirebase('clients', clientId, individualClients[clientIndex]);
                    
                    // Actualizar UI
                    if (viewSegmentsBtn.classList.contains('active')) {
                        renderSegmentCards(segmentDefinitions);
                        filterSegments(document.querySelector('.filter-btn.active-filter').dataset.filter);
                    } else {
                        renderIndividualClientList(individualClients, sortBySelect.value, sortOrderSelect.value);
                    }
                    
                    // Actualizar otras vistas
                    updateDashboard();
                    renderPortfolioChart();
                    renderSalesBySegmentChart();
                    populateDeliveryClientSelect();
                    populateSaleClientSelect();
                    populateCRMClientSelect();
                    
                    // Actualizar mapa si está visible
                    if (mapInstance) {
                        updateMapMarkers();
                    }
                    
                    // Cerrar modal
                    editClientModal.classList.remove('show');
                    editClientForm.reset();
                    
                    showNotification('Cliente actualizado exitosamente', 'success');
                }
            });

            // Modal para añadir venta
            addSaleBtn.addEventListener('click', () => {
                addSaleModal.classList.add('show');
            });

            closeAddSaleModalBtn.addEventListener('click', () => {
                addSaleModal.classList.remove('show');
                addSaleForm.reset();
            });

            cancelAddSaleBtn.addEventListener('click', () => {
                addSaleModal.classList.remove('show');
                addSaleForm.reset();
            });

            addSaleModal.addEventListener('click', (e) => {
                if (e.target === addSaleModal) {
                    addSaleModal.classList.remove('show');
                    addSaleForm.reset();
                }
            });

            // Formulario para añadir venta
            addSaleForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const clientId = parseInt(saleClientSelect.value);
                const amount = parseFloat(saleAmountInput.value);
                const products = saleProductsInput.value.trim();
                const date = saleDateInput.value;

                const client = individualClients.find(c => c.id === clientId);
                if (client) {
                    // Añadir venta
                    const newSale = {
                        id: nextSaleId++,
                        clientId: clientId,
                        amount: amount,
                        products: products,
                        date: date
                    };
                    
                    sales.push(newSale);
                    
                    // Guardar en Firebase
                    saveToFirebase('sales', newSale);

                    // Actualizar información del cliente
                    client.totalPurchases += amount;
                    client.lastPurchase = date.split('T')[0];
                    
                    // Actualizar cliente en Firebase
                    updateInFirebase('clients', client.id, {
                        totalPurchases: client.totalPurchases,
                        lastPurchase: client.lastPurchase
                    });

                    // Actualizar UI
                    renderSales();
                    updateDashboard();
                    renderSalesBySegmentChart();
                    renderSalesTrendChart();
                    if (viewSegmentsBtn.classList.contains('active')) {
                        renderSegmentCards(segmentDefinitions);
                    }

                    // Cerrar modal y resetear
                    addSaleModal.classList.remove('show');
                    addSaleForm.reset();
                    saleDateInput.value = new Date().toISOString().slice(0, 16);

                    showNotification(`Venta de ${formatCurrency(amount)} registrada para ${client.name}`, 'success');
                }
            });

            // Modal para añadir interacción
            addInteractionBtn.addEventListener('click', () => {
                addInteractionModal.classList.add('show');
            });

            closeAddInteractionModalBtn.addEventListener('click', () => {
                addInteractionModal.classList.remove('show');
                addInteractionForm.reset();
            });

            cancelAddInteractionBtn.addEventListener('click', () => {
                addInteractionModal.classList.remove('show');
                addInteractionForm.reset();
            });

            addInteractionModal.addEventListener('click', (e) => {
                if (e.target === addInteractionModal) {
                    addInteractionModal.classList.remove('show');
                    addInteractionForm.reset();
                }
            });

            // Formulario para añadir interacción
            addInteractionForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const clientId = parseInt(crmClientSelect.value);
                const type = document.getElementById('interaction-type').value;
                const notes = document.getElementById('interaction-notes').value.trim();
                const satisfaction = document.getElementById('interaction-satisfaction').value ? 
                    parseInt(document.getElementById('interaction-satisfaction').value) : null;
                const date = document.getElementById('interaction-date').value;

                // Añadir interacción
                const newInteraction = {
                    id: nextInteractionId++,
                    clientId: clientId,
                    type: type,
                    notes: notes,
                    satisfaction: satisfaction,
                    date: date
                };
                
                interactions.push(newInteraction);
                
                // Guardar en Firebase
                saveToFirebase('interactions', newInteraction);

                // Actualizar timeline
                showInteractionsTimeline(clientId);

                // Cerrar modal y resetear
                addInteractionModal.classList.remove('show');
                addInteractionForm.reset();
                document.getElementById('interaction-date').value = new Date().toISOString().slice(0, 16);

                showNotification('Interacción registrada exitosamente', 'success');
            });

            // CRM client select
            crmClientSelect.addEventListener('change', (e) => {
                const clientId = e.target.value;
                if (clientId) {
                    showClientCRM(clientId);
                } else {
                    clientInfoSection.classList.add('hidden');
                    addInteractionBtn.disabled = true;
                }
            });

            // Botones de cambio de vista
            viewSegmentsBtn.addEventListener('click', () => {
                viewSegmentsBtn.classList.replace('inactive', 'active');
                viewIndividualClientsBtn.classList.replace('active', 'inactive');
                segmentFilterContainer.style.display = 'flex';
                sortOptionsContainer.style.display = 'none';
                renderSegmentCards(segmentDefinitions);
                filterSegments(document.querySelector('.filter-btn.active-filter').dataset.filter);
            });

            viewIndividualClientsBtn.addEventListener('click', () => {
                viewIndividualClientsBtn.classList.replace('inactive', 'active');
                viewSegmentsBtn.classList.replace('active', 'inactive');
                segmentFilterContainer.style.display = 'none';
                sortOptionsContainer.style.display = 'flex';
                renderIndividualClientList(individualClients, sortBySelect.value, sortOrderSelect.value);
            });

            // Lógica de ordenamiento para lista de clientes individuales
            sortBySelect.addEventListener('change', () => {
                renderIndividualClientList(individualClients, sortBySelect.value, sortOrderSelect.value);
            });

            sortOrderSelect.addEventListener('change', () => {
                renderIndividualClientList(individualClients, sortBySelect.value, sortOrderSelect.value);
            });

            // Añadir entrega
            addDeliveryBtn.addEventListener('click', () => {
                const clientId = deliveryClientSelect.value;
                const deliveryDate = deliveryDateInput.value;

                if (!clientId || !deliveryDate) {
                    showNotification('Por favor, selecciona un cliente y una fecha', 'warning');
                    return;
                }

                const client = individualClients.find(c => c.id == clientId);
                if (client) {
                    const newDelivery = {
                        id: nextDeliveryId++,
                        clientId: client.id,
                        clientName: client.name,
                        date: deliveryDate
                    };
                    
                    deliveries.push(newDelivery);
                    
                    // Guardar en Firebase
                    saveToFirebase('deliveries', newDelivery);
                    
                    renderDeliveries();
                    updateDashboard();
                    deliveryClientSelect.value = '';
                    deliveryDateInput.value = new Date().toISOString().split('T')[0];
                    
                    showNotification(`Entrega registrada para ${client.name}`, 'success');
                }
            });

            // Añadir recordatorio
            addReminderBtn.addEventListener('click', () => {
                const segmentId = reminderSegmentSelect.value;
                const reminderDay = reminderDaySelect.value;
                const reminderText = reminderTextInput.value.trim();

                if (!segmentId || !reminderDay || !reminderText) {
                    showNotification('Por favor, completa todos los campos', 'warning');
                    return;
                }

                const segment = segmentDefinitions.find(s => s.id == segmentId);
                if (segment) {
                    const newReminder = {
                        id: nextReminderId++,
                        segmentId: segment.id,
                        segmentCategory: segment.category,
                        day: reminderDay,
                        text: reminderText
                    };
                    
                    weeklyReminders.push(newReminder);
                    
                    // Guardar en Firebase
                    saveToFirebase('reminders', newReminder);
                    
                    renderReminders();
                    reminderSegmentSelect.value = '';
                    reminderDaySelect.value = '';
                    reminderTextInput.value = '';
                    
                    showNotification('Recordatorio configurado exitosamente', 'success');
                }
            });

            // ==========================================
            // CARGAR DATOS Y COMPLETAR INICIALIZACIÓN
            // ==========================================
            
            try {
                // Si hay Firebase configurado, los datos se cargarán automáticamente
                // Si no, cargar datos locales
                if (isOfflineMode) {
                    // Cargar datos guardados localmente
                    const savedClients = loadData('clients');
                    const savedSales = loadData('sales');
                    const savedDeliveries = loadData('deliveries');
                    const savedReminders = loadData('reminders');
                    const savedInteractions = loadData('interactions');
                    
                    if (savedClients.length > 0) {
                        individualClients = savedClients;
                        nextIndividualClientId = Math.max(...individualClients.map(c => c.id)) + 1;
                    }
                    if (savedSales.length > 0) {
                        sales = savedSales;
                        nextSaleId = Math.max(...sales.map(s => s.id)) + 1;
                    }
                    if (savedDeliveries.length > 0) {
                        deliveries = savedDeliveries;
                        nextDeliveryId = Math.max(...deliveries.map(d => d.id)) + 1;
                    }
                    if (savedReminders.length > 0) {
                        weeklyReminders = savedReminders;
                        nextReminderId = Math.max(...weeklyReminders.map(r => r.id)) + 1;
                    }
                    if (savedInteractions.length > 0) {
                        interactions = savedInteractions;
                        nextInteractionId = Math.max(...interactions.map(i => i.id)) + 1;
                    }
                    
                    // Si no hay datos guardados, usar datos de ejemplo
                    if (sales.length === 0 && individualClients.length > 0) {
                        console.log('Iniciando con datos de ejemplo...');
                        
                        const sampleSales = [
                            { id: 1, clientId: 1, amount: 1500, products: '5 bolsas grandes', date: '2024-01-20T10:30:00' },
                            { id: 2, clientId: 3, amount: 2000, products: '8 bolsas grandes', date: '2024-01-21T14:15:00' },
                            { id: 3, clientId: 5, amount: 800, products: '3 bolsas medianas', date: '2024-01-22T09:00:00' },
                            { id: 4, clientId: 10, amount: 1200, products: '4 bolsas grandes', date: '2024-01-23T16:45:00' },
                            { id: 5, clientId: 2, amount: 1800, products: '6 bolsas grandes, 2 pequeñas', date: '2024-01-24T11:20:00' }
                        ];
                        sales = sampleSales;
                        nextSaleId = 6;

                        const sampleInteractions = [
                            { id: 1, clientId: 1, type: 'visit', notes: 'Cliente muy satisfecho con el producto', satisfaction: 5, date: '2024-01-15T10:00:00' },
                            { id: 2, clientId: 3, type: 'call', notes: 'Solicitó información sobre precios al mayoreo', satisfaction: null, date: '2024-01-18T14:30:00' },
                            { id: 3, clientId: 5, type: 'complaint', notes: 'El último pedido llegó con retraso', satisfaction: 2, date: '2024-01-19T09:15:00' },
                            { id: 4, clientId: 10, type: 'compliment', notes: 'Excelente sabor, sus clientes están encantados', satisfaction: 5, date: '2024-01-22T17:00:00' }
                        ];
                        interactions = sampleInteractions;
                        nextInteractionId = 5;
                    }
                }

                // Renderizar acordeón de recomendaciones
                const accordionContainer = document.getElementById('recommendations-accordion');
                accordionContainer.innerHTML = '';
                recommendationsData.forEach((item, index) => {
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item glass-card rounded-xl shadow-lg';
                    accordionItem.innerHTML = `
                        <button class="w-full flex justify-between items-center text-left p-6 font-semibold text-xl">
                            <span>${item.title}</span>
                            <span class="text-2xl transition-transform transform">+</span>
                        </button>
                        <div class="overflow-hidden max-h-0 transition-all duration-500 ease-in-out">
                            <div class="p-6 pt-0 text-gray-700">
                               ${item.content}
                            </div>
                        </div>
                    `;
                    accordionContainer.appendChild(accordionItem);

                    const button = accordionItem.querySelector('button');
                    const content = accordionItem.querySelector('div');
                    const icon = accordionItem.querySelector('span:last-child');

                    button.addEventListener('click', () => {
                        const isExpanded = content.style.maxHeight && content.style.maxHeight !== '0px';
                        if (isExpanded) {
                            content.style.maxHeight = '0px';
                            icon.style.transform = 'rotate(0deg)';
                        } else {
                            content.style.maxHeight = content.scrollHeight + 'px';
                            icon.style.transform = 'rotate(45deg)';
                        }
                    });
                });

                // Establecer fecha actual en los campos de fecha
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                deliveryDateInput.value = dateStr;
                
                const dateTimeStr = today.toISOString().slice(0, 16);
                saleDateInput.value = dateTimeStr;
                document.getElementById('interaction-date').value = dateTimeStr;

                // Renderizar componentes iniciales
                console.log('Renderizando componentes...');
                renderSegmentCards(segmentDefinitions);
                updateOverviewMetrics();
                updateDashboard();
                renderPortfolioChart();
                renderSalesBySegmentChart();
                renderSalesTrendChart();
                populateCategorySelect();
                populateDeliveryClientSelect();
                populateSaleClientSelect();
                populateCRMClientSelect();
                populateReminderSegmentSelect();
                renderDeliveries();
                renderReminders();
                renderSales();

                // Actualizar fecha de última actualización
                document.getElementById('last-update').textContent = formatDate(new Date());
                
                // Ocultar loading overlay
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    console.log('Aplicación cargada exitosamente');
                }, 500);
                
            } catch (error) {
                console.error('Error durante la inicialización:', error);
                throw error;
            }
        }
    </script>
</body>
</html>